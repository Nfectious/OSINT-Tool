<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VALKYRIE OSINT</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#111;--bg2:#0f0f18;--bg3:#141420;--panel:#12121e;
  --red:#f00;--red-dim:#991b1b;--red-glow:#ff2020;
  --amber:#f59e0b;--amber-dim:#92400e;
  --green:#0f0;--green-dim:#15803d;
  --cyan:#06b6d4;--cyan-dim:#0e7490;
  --text:#fff;--text-dim:#94a3b8;--text-muted:#475569;
  --border:#1e293b;--border-light:#334155;
  --mono:'Share Tech Mono',monospace;
  --radius:4px;
}
html{font-size:16px}
body{
  background:var(--bg);color:var(--text);font-family:var(--mono);
  min-height:100vh;overflow-x:hidden;
  background-image:
    linear-gradient(rgba(0,255,0,.02) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,255,0,.02) 1px,transparent 1px);
  background-size:40px 40px;
  font-size:16px;
}
/* Scanline overlay */
body::after{
  content:'';position:fixed;top:0;left:0;width:100%;height:100%;
  pointer-events:none;z-index:9999;
  background:repeating-linear-gradient(
    0deg,transparent,transparent 2px,rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px
  );
}
/* Header */
.header{
  border-bottom:1px solid var(--border);
  padding:1.5rem 2rem;position:relative;overflow:hidden;
  background:linear-gradient(180deg,#0a0a0a 0%,var(--bg) 100%);
}
.header::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--green),var(--amber),var(--green),transparent);
}
.header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.brand h1{
  font-size:1.75rem;letter-spacing:.3em;color:var(--green);
  text-shadow:0 0 30px rgba(0,255,0,.4),0 0 60px rgba(0,255,0,.15);
}
.brand .sub{font-size:.85rem;letter-spacing:.25em;color:var(--text-dim);margin-top:.2rem}
.header-status{display:flex;gap:1.5rem;align-items:center}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;
  box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.clock{color:var(--amber);font-size:.9rem}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:1.5rem 2rem;padding-bottom:220px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
.full-width{grid-column:1/-1}

/* Panels */
.panel{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;
}
.panel-head{
  padding:.75rem 1rem;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:.6rem;
  background:rgba(255,255,255,.02);
}
.panel-head .dot{width:6px;height:6px;border-radius:50%}
.panel-head .label{font-size:.75rem;letter-spacing:.15em;text-transform:uppercase;color:var(--text-dim)}
.panel-body{padding:1.25rem}

/* Form elements */
.field{margin-bottom:1rem}
.field label{display:block;font-size:.75rem;letter-spacing:.15em;color:var(--text-dim);margin-bottom:.35rem;text-transform:uppercase}
.field input,.field select,.field textarea{
  width:100%;padding:.7rem .9rem;background:var(--bg);border:1px solid var(--border);
  color:var(--text);font-family:var(--mono);font-size:1rem;border-radius:var(--radius);
  outline:none;transition:border-color .2s,box-shadow .2s;
}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--green);box-shadow:0 0 8px rgba(0,255,0,.2)}
.field select{cursor:pointer;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%2394a3b8'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right .8rem center;padding-right:2rem;
}
.field textarea{resize:vertical;min-height:60px}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1.3rem;
  font-family:var(--mono);font-size:.875rem;letter-spacing:.1em;
  border:1px solid var(--border);border-radius:var(--radius);
  cursor:pointer;transition:all .2s ease;text-transform:uppercase;
  background:var(--bg);color:var(--text);
}
.btn:hover{border-color:var(--text-dim);background:var(--bg2)}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn-red{
  background:linear-gradient(180deg,#b91c1c,#7f1d1d);
  border-color:#b91c1c;color:#fff;
  box-shadow:0 0 10px rgba(255,0,0,.3);
}
.btn-red:hover:not(:disabled){box-shadow:0 0 20px rgba(255,0,0,.5);background:#dc2626;transform:scale(1.04)}
.btn-red:active:not(:disabled){transform:scale(.97)}
.btn-amber{
  background:linear-gradient(180deg,var(--amber-dim),#78350f);
  border-color:var(--amber-dim);color:var(--amber);
  box-shadow:0 0 10px rgba(245,158,11,.2);
}
.btn-amber:hover:not(:disabled){box-shadow:0 0 20px rgba(245,158,11,.4);transform:scale(1.04)}
.btn-amber:active:not(:disabled){transform:scale(.97)}
.btn-cyan{
  background:linear-gradient(180deg,var(--cyan-dim),#164e63);
  border-color:var(--cyan-dim);color:var(--cyan);
  box-shadow:0 0 10px rgba(6,182,212,.2);
}
.btn-cyan:hover:not(:disabled){box-shadow:0 0 20px rgba(6,182,212,.4);transform:scale(1.04)}
.btn-cyan:active:not(:disabled){transform:scale(.97)}
.btn-green{
  background:linear-gradient(180deg,#166534,#14532d);
  border-color:#16a34a;color:var(--green);
  box-shadow:0 0 10px rgba(0,255,0,.2);
}
.btn-green:hover:not(:disabled){box-shadow:0 0 20px rgba(0,255,0,.4);transform:scale(1.04)}
.btn-green:active:not(:disabled){transform:scale(.97)}
.btn[disabled][title]{position:relative}
.btn[disabled]:hover::after{
  content:attr(title);position:absolute;bottom:110%;left:50%;transform:translateX(-50%);
  padding:.3rem .6rem;background:#1e293b;color:var(--text-dim);font-size:.7rem;
  border:1px solid var(--border);border-radius:3px;white-space:nowrap;z-index:10;
  pointer-events:none;
}
.btn-lg{padding:.9rem 2rem;font-size:1rem;letter-spacing:.2em}
.btn-block{width:100%;justify-content:center}

/* Entity list */
.entity-list{list-style:none;margin-top:.75rem}
.entity-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:.6rem .85rem;border:1px solid var(--border);border-radius:var(--radius);
  margin-bottom:.4rem;font-size:.875rem;background:var(--bg);
}
.entity-item .etype{
  display:inline-block;padding:.2rem .5rem;border-radius:2px;font-size:.7rem;
  letter-spacing:.1em;text-transform:uppercase;margin-right:.5rem;
  background:var(--red-dim);color:var(--red);border:1px solid var(--red-dim);
}
.entity-item .eval{color:var(--text)}
.entity-item .remove{cursor:pointer;color:var(--text-muted);font-size:.85rem;background:none;border:1px solid var(--red-dim);border-radius:2px;padding:.15rem .4rem;transition:all .2s;font-family:var(--mono)}
.entity-item .remove:hover{color:var(--red);border-color:var(--red);background:rgba(255,0,0,.1)}
/* Clear-targets bar */
.clear-targets-bar{display:flex;align-items:center;justify-content:space-between;margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)}
.targets-count{font-size:.75rem;color:var(--text-dim)}
/* Admin mode banner */
.admin-banner{
  display:flex;align-items:center;gap:.75rem;padding:.75rem 1.25rem;
  margin-bottom:1rem;border-radius:var(--radius);
  background:rgba(255,0,0,.07);border:1px solid var(--red-dim);
  font-size:.9rem;color:var(--red);box-shadow:0 0 18px rgba(255,0,0,.12);
}
.admin-banner i{font-size:1.1rem;flex-shrink:0}
.admin-banner strong{letter-spacing:.1em}
/* Run counter glow when low */
.runs-low{animation:runs-glow 1.5s ease-in-out infinite alternate}
@keyframes runs-glow{from{text-shadow:0 0 0 transparent}to{text-shadow:0 0 8px rgba(245,158,11,.6)}}
.entity-status{font-size:.7rem;padding:.15rem .45rem;border-radius:2px;letter-spacing:.05em}
.entity-status.pending{color:var(--text-dim);border:1px solid var(--text-muted)}
.entity-status.running{color:var(--amber);border:1px solid var(--amber-dim);animation:pulse 1s infinite}
.entity-status.complete{color:var(--green);border:1px solid var(--green-dim)}

/* Run status */
.run-status{
  text-align:center;padding:1.5rem;font-size:1rem;color:var(--amber);
  display:none;
}
.run-status.active{display:block}
.blink{animation:blink 1s step-end infinite}
@keyframes blink{50%{opacity:0}}

/* Findings */
.findings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;margin-top:1rem}
.finding-card{
  background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);
  padding:1rem;position:relative;border-left:3px solid var(--border);
}
.finding-card.sev-critical{border-left-color:#dc2626}
.finding-card.sev-high{border-left-color:#f97316}
.finding-card.sev-medium{border-left-color:#eab308}
.finding-card.sev-low{border-left-color:#3b82f6}
.finding-card.sev-info{border-left-color:#22c55e}
.finding-card.sev-error{border-left-color:#6b7280}
.finding-tool{font-size:.75rem;letter-spacing:.1em;color:var(--text-dim);text-transform:uppercase}
.finding-severity{
  position:absolute;top:.75rem;right:.75rem;font-size:.65rem;letter-spacing:.1em;
  padding:.15rem .5rem;border-radius:2px;text-transform:uppercase;font-weight:bold;
}
.sev-critical .finding-severity{background:rgba(220,38,38,.2);color:#dc2626}
.sev-high .finding-severity{background:rgba(249,115,22,.2);color:#f97316}
.sev-medium .finding-severity{background:rgba(234,179,8,.2);color:#eab308}
.sev-low .finding-severity{background:rgba(59,130,246,.2);color:#3b82f6}
.sev-info .finding-severity{background:rgba(34,197,94,.2);color:#22c55e}
.sev-error .finding-severity{background:rgba(107,114,128,.2);color:#6b7280}
.finding-summary{margin-top:.5rem;font-size:.875rem;color:var(--text);line-height:1.5}
.finding-entity{font-size:.75rem;color:var(--cyan);margin-top:.5rem}
.finding-meta{margin-top:.6rem;display:flex;flex-wrap:wrap;gap:.4rem}
.finding-meta .tag{
  font-size:.65rem;padding:.15rem .45rem;border-radius:2px;
  background:rgba(255,255,255,.05);color:var(--text-dim);border:1px solid var(--border);
}
.finding-actions{margin-top:.6rem;display:flex;flex-wrap:wrap;gap:.4rem}
.finding-actions .btn{font-size:.7rem;padding:.35rem .65rem}
.platforms-list{margin-top:.4rem;font-size:.8rem;color:var(--text-dim);line-height:1.6}
.platforms-list span{
  display:inline-block;padding:.15rem .45rem;margin:.1rem;border-radius:2px;
  background:rgba(6,182,212,.1);color:var(--cyan);border:1px solid rgba(6,182,212,.2);
}
.premium-badge{
  display:inline-block;font-size:.6rem;letter-spacing:.08em;padding:.1rem .4rem;
  border-radius:2px;background:rgba(234,179,8,.15);color:#eab308;
  border:1px solid rgba(234,179,8,.3);text-transform:uppercase;margin-left:.4rem;vertical-align:middle;
}
.finding-detail-box{
  margin-top:.6rem;padding:.6rem;background:rgba(6,182,212,.05);
  border:1px solid rgba(6,182,212,.12);border-radius:4px;font-size:.82rem;line-height:1.8;
}
.finding-detail-box .detail-title{
  font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--cyan);margin-bottom:.3rem;
}
.profile-link{
  display:inline-block;padding:.15rem .45rem;margin:.1rem;border-radius:2px;
  background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);color:#22c55e;
  font-size:.75rem;text-decoration:none;
}
.profile-link:hover{background:rgba(34,197,94,.2)}
.flag-badge{
  display:inline-block;padding:.1rem .35rem;border-radius:2px;font-size:.7rem;
  background:rgba(249,115,22,.15);color:#f97316;border:1px solid rgba(249,115,22,.3);margin:.1rem;
}
/* Cross-referencing */
.cross-ref-section{
  margin-top:.7rem;padding:.6rem;
  background:rgba(168,85,247,.05);border:1px solid rgba(168,85,247,.2);border-radius:4px;
}
.cross-ref-header{
  font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:#a855f7;
  margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem;
}
.cross-ref-badge{
  display:inline-flex;align-items:center;gap:.3rem;
  font-size:.65rem;padding:.15rem .45rem;border-radius:10px;
  background:rgba(168,85,247,.15);color:#a855f7;border:1px solid rgba(168,85,247,.3);
  font-weight:bold;
}
.cross-ref-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:.3rem .4rem;margin:.2rem 0;border-radius:3px;font-size:.78rem;
  background:rgba(168,85,247,.04);border:1px solid rgba(168,85,247,.1);
}
.cross-ref-item .xref-meta{color:var(--text-dim);font-size:.72rem;}
.cross-ref-item .btn-xref{
  font-size:.65rem;padding:.2rem .45rem;border:1px solid rgba(168,85,247,.35);
  background:transparent;color:#a855f7;border-radius:2px;cursor:pointer;white-space:nowrap;
}
.cross-ref-item .btn-xref:hover{background:rgba(168,85,247,.15);}
/* Cross-ref count badge in investigation table */
.xref-count-badge{
  display:inline-flex;align-items:center;gap:.25rem;
  font-size:.65rem;padding:.1rem .35rem;border-radius:10px;
  background:rgba(168,85,247,.15);color:#a855f7;border:1px solid rgba(168,85,247,.3);
}

/* Patterns / Analysis */
.pattern-card{
  background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);
  padding:1rem;margin-bottom:.75rem;border-left:3px solid var(--amber);
}
.pattern-card.type-summary{border-left-color:var(--cyan)}
.pattern-card.type-relationship{border-left-color:var(--amber)}
.pattern-card.type-anomaly{border-left-color:var(--red)}
.pattern-card.type-lead{border-left-color:var(--green)}
.pattern-card.type-recommendation{border-left-color:#a855f7}
.pattern-type{font-size:.7rem;letter-spacing:.15em;text-transform:uppercase;margin-bottom:.4rem}
.type-summary .pattern-type{color:var(--cyan)}
.type-relationship .pattern-type{color:var(--amber)}
.type-anomaly .pattern-type{color:var(--red)}
.type-lead .pattern-type{color:var(--green)}
.type-recommendation .pattern-type{color:#a855f7}
.pattern-desc{font-size:.875rem;line-height:1.6;color:var(--text)}
.pattern-conf{font-size:.7rem;color:var(--text-dim);margin-top:.4rem}

/* Terminal */
.terminal{
  position:fixed;bottom:0;left:0;right:0;height:180px;z-index:100;
  background:var(--bg);border-top:1px solid var(--border);
  display:flex;flex-direction:column;
}
.terminal-head{
  padding:.4rem 1rem;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(255,255,255,.02);flex-shrink:0;
}
.terminal-head .label{font-size:.7rem;letter-spacing:.15em;color:var(--text-dim);text-transform:uppercase}
.terminal-toggle{cursor:pointer;color:var(--text-dim);font-size:.8rem;background:none;border:none;font-family:var(--mono)}
.terminal-toggle:hover{color:var(--text)}
.terminal-body{
  flex:1;overflow-y:auto;padding:.5rem 1rem;font-size:.875rem;line-height:1.7;
  font-family:'Share Tech Mono',monospace;
}
.terminal.collapsed{height:32px}
.terminal.collapsed .terminal-body{display:none}
.log-line{white-space:pre-wrap;word-break:break-all}
.log-line.info{color:var(--green)}
.log-line.error{color:var(--red)}
.log-line.warn{color:var(--amber)}
.log-line.system{color:var(--cyan)}

/* Misc */
.hidden{display:none!important}
.mt-1{margin-top:.75rem}
.mt-2{margin-top:1.5rem}
.text-center{text-align:center}
.text-dim{color:var(--text-dim)}
.text-sm{font-size:.8rem}

/* Active Investigations Table */
.inv-table{width:100%;border-collapse:collapse;font-size:.875rem}
.inv-table th{text-align:left;padding:.5rem .75rem;font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--text-dim);border-bottom:1px solid var(--border)}
.inv-table td{padding:.6rem .75rem;border-bottom:1px solid var(--border);cursor:pointer}
.inv-table tr:hover td{background:rgba(0,255,0,.06)}
.inv-table tr.selected td{background:rgba(0,255,0,.12);color:var(--green)}
.inv-table tr.demo-highlight td{
  box-shadow:inset 0 0 0 1px var(--green),0 0 8px rgba(0,255,0,.2);
}

/* Welcome banner */
.welcome-banner{
  background:#1e3a5f;padding:1rem;margin:.75rem 0;border-radius:6px;
  border:1px solid #00ff9d;text-align:center;font-size:.9rem;line-height:1.6;
}
.welcome-banner strong{color:#00ff9d}
.welcome-banner .wb-sub{color:var(--text-dim);font-size:.85rem;margin-top:.3rem}

/* ─── ETHICAL USE DISCLAIMER ─── */
.ethical-disclaimer{
  background:#300000;
  border:2px solid #660000;
  border-radius:var(--radius);
  padding:1.25rem 1.5rem;
  margin-bottom:1.25rem;
  text-align:center;
  line-height:1.7;
}
.ethical-disclaimer .ed-title{
  font-size:1rem;font-weight:bold;letter-spacing:.2em;color:#ff4444;
  text-transform:uppercase;margin-bottom:.5rem;
  text-shadow:0 0 10px rgba(255,0,0,.3);
}
.ethical-disclaimer .ed-body{
  font-size:.875rem;font-weight:bold;color:#fff;line-height:1.7;
}
.ethical-disclaimer .ed-ack{
  margin-top:.75rem;display:flex;align-items:center;justify-content:center;gap:.6rem;
  font-size:.85rem;color:#ccc;cursor:pointer;
}
.ethical-disclaimer .ed-ack input[type="checkbox"]{
  accent-color:var(--green);width:18px;height:18px;flex-shrink:0;cursor:pointer;
}
.ethical-disclaimer.acknowledged{
  border-color:#442222;background:#200000;
}
.ethical-disclaimer.acknowledged .ed-ack{display:none}
.ethical-disclaimer.acknowledged .ed-body{
  font-size:.8rem;color:#ccc;font-weight:normal;
}

/* ─── Why Premium collapsible ─── */
.why-premium{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  margin-bottom:1.25rem;overflow:hidden;
}
.why-premium-toggle{
  width:100%;display:flex;align-items:center;justify-content:space-between;
  padding:.85rem 1.25rem;background:rgba(245,158,11,.06);
  border:none;cursor:pointer;font-family:var(--mono);
  font-size:.9rem;letter-spacing:.12em;text-transform:uppercase;
  color:var(--amber);
}
.why-premium-toggle:hover{background:rgba(245,158,11,.1)}
.why-premium-toggle .chevron{transition:transform .2s;font-size:.75rem}
.why-premium.open .why-premium-toggle .chevron{transform:rotate(180deg)}
.why-premium-body{
  max-height:0;overflow:hidden;transition:max-height .3s ease;
}
.why-premium.open .why-premium-body{max-height:500px}
.why-premium-inner{padding:1.25rem}
.why-premium-inner ul{list-style:none;margin-bottom:1.25rem}
.why-premium-inner ul li{
  padding:.45rem 0;font-size:.9rem;color:var(--text);
  display:flex;align-items:flex-start;gap:.6rem;
}
.why-premium-inner ul li .check{color:var(--green);font-size:.85rem;margin-top:.1rem;flex-shrink:0}

/* Freemium bar */
.freemium-bar{
  display:flex;align-items:center;justify-content:center;gap:1rem;
  padding:.6rem 1rem;margin-bottom:1rem;border-radius:var(--radius);
  background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);
  font-size:.85rem;flex-wrap:wrap;
}
.freemium-bar .runs-left{color:var(--amber);font-weight:bold}
.freemium-bar .premium-badge{color:var(--green);font-weight:bold}
.freemium-bar .progress-wrap{
  width:120px;height:6px;background:var(--border);border-radius:3px;overflow:hidden;
}
.freemium-bar .progress-fill{
  height:100%;background:var(--green);border-radius:3px;
  box-shadow:0 0 6px rgba(0,255,0,.4);transition:width .3s;
}

/* PayPal upgrade modal */
.paywall-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:500;
  background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;
}
.paywall-overlay.hidden{display:none}
.paywall-box{
  width:420px;max-width:92vw;background:var(--panel);border:1px solid var(--amber);
  border-radius:var(--radius);padding:2rem;text-align:center;
  box-shadow:0 0 40px rgba(245,158,11,.2);
}
.paywall-box h2{color:var(--amber);font-size:1.25rem;letter-spacing:.15em;margin-bottom:.75rem}
.paywall-box p{color:var(--text-dim);font-size:.85rem;line-height:1.5;margin-bottom:1.25rem}
.paywall-box .price{font-size:1.5rem;color:var(--green);margin-bottom:1rem}
.paywall-box ul{
  text-align:left;list-style:none;margin-bottom:1.25rem;font-size:.85rem;color:var(--text);
}
.paywall-box ul li{padding:.3rem 0}
.paywall-box ul li i{color:var(--green);margin-right:.5rem;width:1rem;text-align:center}
#paypal-button-container{min-height:50px;margin-bottom:.75rem}
.paywall-close{
  background:none;border:1px solid var(--border);color:var(--text-dim);
  padding:.4rem 1rem;border-radius:var(--radius);cursor:pointer;font-family:var(--mono);
  font-size:.8rem;
}
.paywall-close:hover{color:var(--text);border-color:var(--text-dim)}

/* AI Teaser overlay */
.ai-teaser-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:510;
  background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;
}
.ai-teaser-overlay.hidden{display:none}
.ai-teaser-box{
  width:520px;max-width:94vw;background:var(--panel);border:1px solid var(--cyan);
  border-radius:var(--radius);padding:2rem;
  box-shadow:0 0 40px rgba(6,182,212,.2);
}
.ai-teaser-box h2{
  color:var(--cyan);font-size:1.1rem;letter-spacing:.12em;margin-bottom:1rem;text-align:center;
}
.ai-teaser-box .teaser-basic{
  background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.2);
  border-radius:var(--radius);padding:1rem;margin-bottom:1.25rem;
  font-size:.85rem;line-height:1.6;color:var(--text);
}
.ai-teaser-box .teaser-basic .teaser-label{
  font-size:.7rem;letter-spacing:.15em;text-transform:uppercase;color:var(--cyan);
  margin-bottom:.4rem;
}
.ai-teaser-box .teaser-upsell{
  background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);
  border-radius:var(--radius);padding:1rem;margin-bottom:1.25rem;
  font-size:.85rem;line-height:1.7;color:var(--amber);text-align:center;
}
.ai-teaser-box .teaser-actions{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap}

/* Consent overlay */
.consent-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:600;
  background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;
}
.consent-overlay.hidden{display:none}
.consent-box{
  width:440px;max-width:92vw;background:var(--panel);border:1px solid var(--green);
  border-radius:var(--radius);padding:2rem;text-align:center;
  box-shadow:0 0 30px rgba(0,255,0,.15);
}
.consent-box h3{color:var(--green);font-size:1.1rem;letter-spacing:.15em;margin-bottom:1rem}
.consent-box p{color:var(--text-dim);font-size:.85rem;line-height:1.6;margin-bottom:1rem}
.consent-box label{
  display:flex;align-items:flex-start;gap:.6rem;text-align:left;
  font-size:.8rem;color:var(--text);margin-bottom:1.25rem;cursor:pointer;
}
.consent-box input[type="checkbox"]{
  margin-top:.2rem;accent-color:var(--green);width:16px;height:16px;flex-shrink:0;
}

/* Footer */
.site-footer{
  text-align:center;padding:1.25rem;color:var(--text-dim);font-size:.85rem;
  border-top:1px solid var(--border);margin-top:2rem;
}
.site-footer .upgrade-hint{color:var(--amber);font-size:.8rem}
.inv-empty{text-align:center;padding:1.5rem;color:var(--text-dim);font-size:.85rem}

/* Step Indicator */
.step-indicator{
  display:flex;align-items:center;justify-content:center;gap:0;
  margin-bottom:1.5rem;padding:1rem;
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
}
.step-item{
  display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;
  font-size:.8rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--text-muted);position:relative;
  transition:all .3s ease;
}
.step-item .step-num{
  width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  border:2px solid var(--text-muted);font-size:.75rem;font-weight:bold;
  transition:all .3s ease;flex-shrink:0;
}
.step-item.active{color:var(--red)}
.step-item.active .step-num{border-color:var(--red);background:var(--red);color:#fff;box-shadow:0 0 12px rgba(255,0,0,.4)}
.step-item.complete{color:var(--green)}
.step-item.complete .step-num{border-color:var(--green);background:var(--green);color:#fff}
.step-connector{width:40px;height:2px;background:var(--text-muted);flex-shrink:0}
.step-connector.done{background:var(--green)}
@media(max-width:768px){
  .step-indicator{flex-wrap:wrap;gap:.5rem}
  .step-connector{width:20px}
  .step-item{font-size:.7rem;padding:.4rem .6rem}
}

/* Onboarding Banner */
.onboarding-banner{
  background:linear-gradient(135deg,#1a0000,#1a1a00);
  border:1px solid var(--red);border-radius:var(--radius);
  padding:1rem 1.25rem;margin-bottom:1.25rem;
  display:flex;align-items:center;gap:1rem;
  animation:onboard-glow 2s ease-in-out infinite alternate;
}
@keyframes onboard-glow{from{box-shadow:0 0 5px rgba(255,0,0,.1)}to{box-shadow:0 0 15px rgba(255,0,0,.2)}}
.onboarding-banner .ob-icon{font-size:1.5rem;color:var(--red);flex-shrink:0}
.onboarding-banner .ob-text{font-size:.85rem;line-height:1.6;color:var(--text);flex:1}
.onboarding-banner .ob-text strong{color:var(--red)}
.onboarding-banner .ob-dismiss{
  background:none;border:1px solid var(--border);color:var(--text-dim);
  padding:.35rem .75rem;border-radius:var(--radius);cursor:pointer;
  font-family:var(--mono);font-size:.75rem;flex-shrink:0;
}
.onboarding-banner .ob-dismiss:hover{color:var(--text);border-color:var(--text-dim)}

/* Section Divider */
.section-divider{
  display:flex;align-items:center;gap:.75rem;
  margin:1.75rem 0 1rem;grid-column:1/-1;
}
.section-divider::before,.section-divider::after{
  content:'';flex:1;height:1px;background:var(--border-light);
}
.section-divider .sd-label{
  font-size:.7rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--text-dim);white-space:nowrap;display:flex;align-items:center;gap:.5rem;
}
.section-divider .sd-num{
  display:inline-flex;align-items:center;justify-content:center;
  width:22px;height:22px;border-radius:50%;border:1px solid var(--red-dim);
  font-size:.65rem;color:var(--red);font-weight:bold;
}

/* Collapsible Panel */
.panel-collapsible .panel-head{cursor:pointer;user-select:none}
.panel-collapsible .panel-head:hover{background:rgba(255,255,255,.04)}
.panel-collapsible .panel-head .collapse-chevron{
  margin-left:auto;font-size:.7rem;transition:transform .2s;color:var(--text-dim);
}
.panel-collapsible.collapsed .panel-body{display:none}
.panel-collapsible.collapsed .collapse-chevron{transform:rotate(-90deg)}
.panel-collapsible .panel-head .collapse-badge{
  margin-left:.5rem;font-size:.7rem;padding:.1rem .5rem;border-radius:10px;
  background:rgba(255,255,255,.08);color:var(--text-dim);
}

/* Delete Project Button */
.btn-delete-sm{
  background:none;border:1px solid var(--red-dim);color:var(--red-dim);
  padding:.25rem .5rem;border-radius:var(--radius);cursor:pointer;
  font-family:var(--mono);font-size:.7rem;transition:all .2s;
}
.btn-delete-sm:hover{border-color:var(--red);color:var(--red);background:rgba(255,0,0,.1)}

/* AI Premium Example Preview */
.ai-example-preview{
  background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.25rem;margin-top:1rem;position:relative;overflow:hidden;
}
.ai-example-preview::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:80px;
  background:linear-gradient(transparent,var(--panel));pointer-events:none;
}
.ai-example-preview .example-label{
  font-size:.65rem;letter-spacing:.15em;text-transform:uppercase;
  color:var(--amber);margin-bottom:.75rem;display:flex;align-items:center;gap:.4rem;
}
.ai-example-preview .example-card{
  background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:var(--radius);
  padding:.75rem;margin-bottom:.6rem;border-left:3px solid var(--cyan);font-size:.85rem;
}
.ai-example-preview .example-card .ex-type{
  font-size:.65rem;letter-spacing:.12em;text-transform:uppercase;color:var(--cyan);margin-bottom:.3rem;
}
.ai-example-preview .example-card .ex-desc{color:var(--text-dim);line-height:1.5;font-size:.8rem}
.ai-example-preview .example-card.ex-anomaly{border-left-color:var(--red)}
.ai-example-preview .example-card.ex-anomaly .ex-type{color:var(--red)}
.ai-example-preview .example-card.ex-lead{border-left-color:var(--green)}
.ai-example-preview .example-card.ex-lead .ex-type{color:var(--green)}
.ai-premium-gate{
  text-align:center;padding:1.5rem;border:1px dashed var(--amber);border-radius:var(--radius);
  margin-top:1rem;background:rgba(245,158,11,.04);
}
.ai-premium-gate .gate-title{color:var(--amber);font-size:1rem;letter-spacing:.12em;margin-bottom:.5rem}
.ai-premium-gate .gate-desc{color:var(--text-dim);font-size:.85rem;line-height:1.6;margin-bottom:1rem}

/* Investigation View Toggle */
.view-toggle{
  display:inline-flex;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
  font-size:.75rem;
}
.view-toggle button{
  padding:.35rem .75rem;background:none;border:none;color:var(--text-dim);
  cursor:pointer;font-family:var(--mono);font-size:.75rem;letter-spacing:.05em;
  transition:all .2s;
}
.view-toggle button:hover{color:var(--text)}
.view-toggle button.active{background:var(--red);color:#fff}

/* Current Investigation Label */
.current-inv-label{
  display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;
  background:rgba(0,255,0,.05);border:1px solid rgba(0,255,0,.15);
  border-radius:var(--radius);margin-bottom:1rem;font-size:.8rem;
}
.current-inv-label .inv-name{color:var(--green);font-weight:bold}
.current-inv-label .inv-id{color:var(--text-dim);font-size:.7rem}

/* My Investigations Tabs */
.inv-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:.75rem}
.inv-tab{
  flex:1;padding:.6rem;text-align:center;font-size:.75rem;letter-spacing:.1em;
  text-transform:uppercase;cursor:pointer;color:var(--text-dim);background:none;
  border:none;font-family:var(--mono);border-bottom:2px solid transparent;transition:all .2s;
}
.inv-tab:hover{color:var(--text)}
.inv-tab.active{color:var(--green);border-bottom-color:var(--green)}
.inv-tab .tab-count{
  display:inline-block;padding:.1rem .4rem;border-radius:8px;font-size:.65rem;
  background:rgba(255,255,255,.08);color:var(--text-dim);margin-left:.3rem;
}
.inv-tab.active .tab-count{background:rgba(0,255,0,.15);color:var(--green)}

/* History table enhancements */
.inv-table .col-date{font-size:.7rem;color:var(--text-dim);white-space:nowrap}
.inv-table .col-targets{font-size:.75rem;color:var(--cyan)}
.inv-table .col-summary{font-size:.75rem;color:var(--text-dim);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inv-actions{display:flex;gap:.3rem;align-items:center}
.btn-view-sm{
  background:none;border:1px solid var(--green-dim);color:var(--green-dim);
  padding:.25rem .5rem;border-radius:var(--radius);cursor:pointer;
  font-family:var(--mono);font-size:.7rem;transition:all .2s;
}
.btn-view-sm:hover{border-color:var(--green);color:var(--green);background:rgba(0,255,0,.1)}
.inv-clear-bar{
  display:flex;align-items:center;justify-content:space-between;margin-top:.75rem;
  padding-top:.75rem;border-top:1px solid var(--border);
}
.inv-persistence-note{font-size:.65rem;color:var(--text-muted);display:flex;align-items:center;gap:.3rem}

/* Pay-per-report unlock badge */
.report-unlocked-badge{
  display:inline-flex;align-items:center;gap:.4rem;
  padding:.3rem .7rem;border-radius:var(--radius);font-size:.7rem;
  letter-spacing:.1em;text-transform:uppercase;
  background:rgba(6,182,212,.1);color:var(--cyan);border:1px solid var(--cyan-dim);
  margin-bottom:.75rem;
}
.btn-buy-report{
  background:linear-gradient(180deg,var(--cyan-dim),#164e63);
  border-color:var(--cyan-dim);color:var(--cyan);
  box-shadow:0 0 10px rgba(6,182,212,.2);
}
.btn-buy-report:hover:not(:disabled){box-shadow:0 0 20px rgba(6,182,212,.4);transform:scale(1.04)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

/* Stats row */
.stats-row{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1.5rem}
.stat-box{
  flex:1;min-width:120px;padding:.75rem 1rem;background:var(--panel);
  border:1px solid var(--border);border-radius:var(--radius);text-align:center;
}
.stat-box .val{font-size:1.5rem;color:var(--green);font-weight:bold}
.stat-box .lbl{font-size:.65rem;letter-spacing:.15em;color:var(--text-dim);text-transform:uppercase;margin-top:.2rem}

/* Auth Overlay */
.auth-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000;
  background:var(--bg);display:flex;align-items:center;justify-content:center;
  background-image:
    linear-gradient(rgba(0,255,0,.02) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,255,0,.02) 1px,transparent 1px);
  background-size:40px 40px;
}
.auth-overlay.hidden{display:none}
.auth-box{
  width:400px;max-width:92vw;background:var(--panel);border:1px solid var(--border);
  border-radius:var(--radius);overflow:hidden;
}
.auth-box .panel-head{padding:.75rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem;background:rgba(255,255,255,.02)}
.auth-box .panel-body{padding:1.25rem}
.auth-tabs{display:flex;border-bottom:1px solid var(--border)}
.auth-tab{
  flex:1;padding:.65rem;text-align:center;font-size:.8rem;letter-spacing:.12em;
  text-transform:uppercase;cursor:pointer;color:var(--text-dim);background:none;
  border:none;font-family:var(--mono);border-bottom:2px solid transparent;
}
.auth-tab.active{color:var(--green);border-bottom-color:var(--green)}
.auth-tab:hover{color:var(--text)}
.auth-error{color:var(--red);font-size:.8rem;margin-bottom:.75rem;display:none}
.auth-info{color:var(--green);font-size:.8rem;margin-bottom:.75rem;display:none}
.user-bar{display:flex;align-items:center;gap:1rem;font-size:.8rem}
.user-bar .user-email{color:var(--cyan)}
.user-bar .user-tier{padding:.15rem .5rem;border-radius:2px;font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;background:rgba(0,255,0,.1);color:var(--green);border:1px solid var(--green-dim)}
.user-bar .btn-logout{margin-left:auto}

/* OPSEC Threat Meter */
.threat-meter{
  font-size:.8rem;letter-spacing:.1em;padding:.25rem .6rem;border-radius:3px;
  background:#1a1a2e;border:1px solid var(--amber);color:var(--amber);
  white-space:nowrap;
}
#threat-level{font-weight:900;text-transform:uppercase}
.threat-minimal{color:#00ff9d;border-color:#00ff9d;background:rgba(0,255,157,.08)}
.threat-guarded{color:var(--cyan);border-color:var(--cyan);background:rgba(6,182,212,.08)}
.threat-elevated{color:var(--amber);border-color:var(--amber);background:rgba(245,158,11,.1)}
.threat-high{color:var(--red);border-color:var(--red);background:rgba(255,0,0,.1);animation:threat-pulse 1.5s infinite}
.threat-critical{color:#ff0066;border-color:#ff0066;background:rgba(255,0,102,.15);animation:threat-pulse 1s infinite}
@keyframes threat-pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Mission Clock */
.mission-clock{text-align:right;line-height:1.3}
.mission-clock .mc-local{font-size:1rem;color:#fff;font-weight:bold}
.mission-clock .mc-zulu{font-size:.75rem;color:var(--text-dim);letter-spacing:.08em}

/* Operator Dossier */
.header-status{position:relative}
.user-bar .user-email{cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:3px}
.user-bar .user-email:hover{color:#fff}
.dossier{
  position:absolute;top:100%;right:0;margin-top:.5rem;
  background:var(--bg);border:1px solid var(--green);border-radius:var(--radius);
  padding:1rem;width:280px;box-shadow:0 0 20px rgba(0,255,0,.15);z-index:200;
  font-size:.85rem;line-height:1.7;
}
.dossier h4{
  margin:0 0 .6rem;color:var(--green);border-bottom:1px solid var(--border);
  padding-bottom:.4rem;text-align:center;font-size:.75rem;letter-spacing:.2em;
}
.dossier p{margin:.3rem 0;color:var(--text)}
.dossier strong{color:var(--text-dim)}

/* ─── Disabled state for gated buttons ─── */
.btn.gated{opacity:.35;pointer-events:none;filter:grayscale(.5)}

/* ─── Responsive: Tablet ─── */
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
  .findings-grid{grid-template-columns:1fr}
}

/* ─── Responsive: Mobile <768px ─── */
@media(max-width:768px){
  .header-inner{flex-direction:column;text-align:center}
  .header-status{flex-wrap:wrap;justify-content:center}
  .brand h1{font-size:1.35rem;letter-spacing:.15em}
  .container{padding:1rem}
  .grid{grid-template-columns:1fr}
  .findings-grid{grid-template-columns:1fr}
  .btn-lg{width:100%;justify-content:center;padding:.9rem 1rem}
  .btn-block{padding:.8rem}
  .panel-body{padding:1rem}
  .field input,.field select,.field textarea{padding:.8rem;font-size:1rem}
  .terminal{height:140px}
  body{padding-bottom:160px}
  .threat-meter{font-size:.7rem}
  .dossier{right:-1rem;width:260px}
  .freemium-bar{flex-direction:column;gap:.5rem}
  .stats-row{gap:.5rem}
  .stat-box{min-width:70px;padding:.5rem}
  .stat-box .val{font-size:1.25rem}
  #panelRun .panel-body{display:flex;flex-direction:column;gap:.75rem;align-items:stretch}
  #panelRun .btn-lg{margin-left:0!important}
  .ethical-disclaimer{padding:1rem}
  .ethical-disclaimer .ed-body{font-size:.8rem}
  .ai-teaser-box{padding:1.25rem}
  .why-premium-inner{padding:1rem}
}
</style>
</head>
<body>

<!-- CONSENT OVERLAY (first visit) -->
<div class="consent-overlay hidden" id="consentOverlay">
  <div class="consent-box">
    <h3><i class="fa-solid fa-shield-halved"></i> VALKYRIE PRIVACY NOTICE</h3>
    <p>VALKYRIE stores <strong>no personal data</strong>. All lookups are processed in-memory and discarded after response. We collect only anonymous aggregate usage stats (total runs, target type distribution, error rate) to improve the platform.</p>
    <label>
      <input type="checkbox" id="consentCheck">
      I agree to anonymous aggregate usage logging for service improvement. I can opt out anytime via the footer link.
    </label>
    <button class="btn btn-green btn-block" id="btnConsent" onclick="acceptConsent()" disabled>
      <i class="fa-solid fa-check"></i> Accept &amp; Continue
    </button>
  </div>
</div>

<!-- AUTH OVERLAY -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <div class="panel-head">
      <span class="dot" style="background:var(--green)"></span>
      <span class="label"><i class="fa-solid fa-shield-halved"></i> VALKYRIE OSINT — ACCESS CONTROL</span>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="showAuthTab('login')"><i class="fa-solid fa-right-to-bracket"></i> Login</button>
      <button class="auth-tab" id="tabRegister" onclick="showAuthTab('register')"><i class="fa-solid fa-user-plus"></i> Register</button>
    </div>
    <div class="panel-body">
      <div class="auth-error" id="authError"></div>
      <div class="auth-info" id="authInfo"></div>
      <!-- Login Form -->
      <div id="loginForm">
        <div class="field">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="operator@valkyrie.io">
        </div>
        <div class="field">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;">
        </div>
        <button class="btn btn-green btn-block" onclick="doLogin()"><i class="fa-solid fa-lock"></i> Authenticate</button>
      </div>
      <!-- Register Form -->
      <div id="registerForm" class="hidden">
        <div class="field">
          <label>Email</label>
          <input type="email" id="regEmail" placeholder="operator@valkyrie.io">
        </div>
        <div class="field">
          <label>Password (min 6 chars)</label>
          <input type="password" id="regPassword" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;">
        </div>
        <div class="field">
          <label>Confirm Password</label>
          <input type="password" id="regPassword2" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;">
        </div>
        <button class="btn btn-green btn-block" onclick="doRegister()"><i class="fa-solid fa-user-shield"></i> Create Account</button>
      </div>
    </div>
  </div>
</div>

<!-- PAYWALL OVERLAY -->
<div class="paywall-overlay hidden" id="paywallOverlay">
  <div class="paywall-box">
    <h2><i class="fa-solid fa-bolt"></i> UPGRADE TO PREMIUM</h2>
    <p>You've used all 5 free runs for today. Upgrade for unlimited access.</p>
    <div class="price">$9.99 <span style="font-size:.8rem;color:var(--text-dim)">/month</span></div>
    <ul>
      <li><i class="fa-solid fa-infinity"></i> Unlimited OSINT runs per day</li>
      <li><i class="fa-solid fa-brain"></i> Full AI Analysis (unlimited)</li>
      <li><i class="fa-solid fa-gauge-high"></i> Priority processing</li>
      <li><i class="fa-solid fa-shield-halved"></i> Advanced source modules</li>
    </ul>
    <div id="paypal-button-container"></div>
    <button class="paywall-close" onclick="closePaywall()">Maybe Later</button>
  </div>
</div>

<!-- AI TEASER OVERLAY (free users after analysis) -->
<div class="ai-teaser-overlay hidden" id="aiTeaserOverlay">
  <div class="ai-teaser-box">
    <h2><i class="fa-solid fa-brain"></i> AI ANALYSIS RESULTS</h2>
    <div class="teaser-basic">
      <div class="teaser-label"><i class="fa-solid fa-file-lines"></i> Basic AI Summary (Free Tier)</div>
      <div id="aiTeaserContent">Analysis processing...</div>
    </div>
    <div class="teaser-upsell">
      <i class="fa-solid fa-lock" style="margin-right:.4rem"></i>
      <strong>Upgrade to Premium</strong> for full AI-powered analysis: deep pattern detection, risk scoring, entity links, threat recommendations, and downloadable report.<br>
      <span style="color:var(--text);font-size:.8rem">Unlock the real intelligence behind your targets.</span>
    </div>
    <div class="teaser-actions">
      <button class="btn btn-buy-report" onclick="closeAiTeaser();showReportPay()">
        <i class="fa-solid fa-file-shield"></i> Full Report &mdash; $4.99
      </button>
      <button class="btn btn-amber" onclick="showPaywall();closeAiTeaser()">
        <i class="fa-solid fa-crown"></i> Subscribe $9.99/mo
      </button>
      <button class="btn" onclick="closeAiTeaser()">Close</button>
    </div>
  </div>
</div>

<!-- PAY-PER-REPORT OVERLAY -->
<div class="paywall-overlay hidden" id="reportPayOverlay">
  <div class="paywall-box" style="border-color:var(--cyan);box-shadow:0 0 40px rgba(6,182,212,.2)">
    <h2 style="color:var(--cyan)"><i class="fa-solid fa-file-shield"></i> FULL DETAILED REPORT</h2>
    <p>Your basic AI summary is ready. Unlock the full detailed report for this investigation.</p>
    <div class="price" style="color:var(--cyan)">$4.99 <span style="font-size:.8rem;color:var(--text-dim)">one-time</span></div>
    <ul>
      <li><i class="fa-solid fa-brain" style="color:var(--cyan)"></i> Deep pattern detection &amp; risk scoring</li>
      <li><i class="fa-solid fa-link" style="color:var(--cyan)"></i> Entity linking &amp; relationship mapping</li>
      <li><i class="fa-solid fa-triangle-exclamation" style="color:var(--cyan)"></i> Anomaly alerts &amp; threat recommendations</li>
      <li><i class="fa-solid fa-download" style="color:var(--cyan)"></i> Downloadable report (JSON)</li>
    </ul>
    <div id="report-paypal-container" style="min-height:50px;margin-bottom:.75rem"></div>
    <div style="display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-amber" onclick="showPaywall();closeReportPay()" style="font-size:.8rem">
        <i class="fa-solid fa-crown"></i> Or subscribe $9.99/mo for unlimited
      </button>
      <button class="paywall-close" onclick="closeReportPay()">Maybe Later</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header class="header">
  <div class="header-inner">
    <div class="brand">
      <h1><i class="fa-solid fa-shield-halved"></i> VALKYRIE OSINT</h1>
      <div class="sub">Intelligence Collection Platform</div>
    </div>
    <div class="header-status">
      <div class="user-bar hidden" id="userBar">
        <span class="user-email" id="userEmail"></span>
        <span class="user-tier" id="userTier"></span>
        <button class="btn btn-logout" onclick="doLogout()" style="font-size:.75rem;padding:.35rem .65rem"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </div>
      <!-- Account Dropdown -->
      <div id="dossierDropdown" class="dossier hidden">
        <h4><i class="fa-solid fa-id-badge"></i> My Account</h4>
        <p><strong>Email:</strong> <span id="dossierClearance">--</span></p>
        <p><strong>Plan:</strong> <span id="dossierTier">Free</span></p>
        <p><strong>Session ID:</strong> <span id="dossierSession">----</span></p>
        <p><strong>Last Login:</strong> <span id="dossierLogin">--</span></p>
        <p><strong>Projects:</strong> <span id="dossierProjects">0</span></p>
      </div>
      <span><span class="status-dot"></span> <span class="text-dim text-sm">ONLINE</span></span>
      <span class="threat-meter" id="opsecThreat">Risk: <span id="threatLevel">--</span></span>
      <div class="mission-clock">
        <div class="mc-local" id="mcLocal">--:--:--</div>
        <div class="mc-zulu">UTC <span id="mcZulu">--:--:--</span></div>
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- ETHICAL USE DISCLAIMER (non-dismissible until acknowledged) -->
  <div class="ethical-disclaimer" id="ethicalDisclaimer">
    <div class="ed-title"><i class="fa-solid fa-exclamation-triangle"></i> VALKYRIE OSINT &mdash; ETHICAL USE ONLY <i class="fa-solid fa-exclamation-triangle"></i></div>
    <div class="ed-body">
      All queries are processed in-memory and discarded after the session.<br>
      We store <strong style="color:#ff4444">NO</strong> personal data (phones, emails, usernames, IPs).<br>
      Only anonymous aggregate stats (run counts, target types, error rates) are collected to improve the tool.<br>
      <strong>You are fully responsible for legal and ethical compliance. Misuse is prohibited.</strong>
    </div>
    <label class="ed-ack" id="ethicalAckLabel">
      <input type="checkbox" id="ethicalAckCheck">
      <span>I Understand &mdash; I will use this tool ethically and legally</span>
    </label>
  </div>

  <!-- WHAT IS VALKYRIE? (collapsible) -->
  <div class="why-premium" id="whatIsValkyrie">
    <button class="why-premium-toggle" onclick="document.getElementById('whatIsValkyrie').classList.toggle('open')" style="color:var(--cyan);background:rgba(6,182,212,.06)">
      <span><i class="fa-solid fa-circle-info" style="margin-right:.5rem"></i> What is VALKYRIE?</span>
      <span class="chevron"><i class="fa-solid fa-chevron-down"></i></span>
    </button>
    <div class="why-premium-body">
      <div class="why-premium-inner" style="font-size:.875rem;line-height:1.8;color:var(--text-dim)">
        <p style="margin-bottom:.75rem"><strong style="color:var(--green)">VALKYRIE OSINT</strong> is an ethical public intelligence tool for looking up phones, emails, usernames, IPs, and domains.</p>
        <ul style="margin-bottom:.5rem">
          <li><span class="check"><i class="fa-solid fa-gift"></i></span> <strong style="color:var(--text)">Free tier:</strong> 5 runs/day, basic carrier lookup + short AI summary</li>
          <li><span class="check"><i class="fa-solid fa-crown" style="color:var(--amber)"></i></span> <strong style="color:var(--text)">Premium ($9.99/mo):</strong> Unlimited runs, full AI patterns/risks, downloadable reports</li>
          <li><span class="check"><i class="fa-solid fa-file-shield" style="color:var(--cyan)"></i></span> <strong style="color:var(--text)">Pay-per-report ($4.99):</strong> Buy a full AI analysis one-time for any investigation</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- WHY PREMIUM? (collapsible) -->
  <div class="why-premium" id="whyPremium">
    <button class="why-premium-toggle" onclick="toggleWhyPremium()">
      <span><i class="fa-solid fa-crown" style="margin-right:.5rem"></i> Why Go Premium?</span>
      <span class="chevron"><i class="fa-solid fa-chevron-down"></i></span>
    </button>
    <div class="why-premium-body">
      <div class="why-premium-inner">
        <ul>
          <li><span class="check"><i class="fa-solid fa-check"></i></span> Unlimited OSINT runs (no 5/day limit)</li>
          <li><span class="check"><i class="fa-solid fa-check"></i></span> Full detailed AI analysis + downloadable reports</li>
          <li><span class="check"><i class="fa-solid fa-check"></i></span> Priority access to new tools</li>
          <li><span class="check"><i class="fa-solid fa-check"></i></span> Support continued development of VALKYRIE</li>
        </ul>
        <div class="text-center">
          <button class="btn btn-amber btn-lg" onclick="showPaywall()">
            <i class="fa-solid fa-bolt"></i> Upgrade Now &mdash; $9.99/mo
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN MODE BANNER (hidden until admin logs in) -->
  <div class="admin-banner hidden" id="adminBanner">
    <i class="fa-solid fa-shield-halved"></i>
    <span><strong>ADMIN MODE &mdash; UNLIMITED ACCESS</strong> &mdash; All limits bypassed. Full AI analysis enabled.</span>
  </div>

  <!-- FREEMIUM BAR -->
  <div class="freemium-bar" id="freemiumBar">
    <i class="fa-solid fa-gauge" style="color:var(--amber)"></i>
    <span class="runs-left" id="runsLeftText">5/5 free runs left today</span>
    <div class="progress-wrap">
      <div class="progress-fill" id="runsProgress" style="width:100%"></div>
    </div>
    <button class="btn btn-amber" style="font-size:.75rem;padding:.3rem .7rem" onclick="showPaywall()" id="btnUpgradeSmall">
      <i class="fa-solid fa-bolt"></i> Upgrade
    </button>
  </div>

  <!-- ONBOARDING BANNER (first login) -->
  <div class="onboarding-banner hidden" id="onboardingBanner">
    <span class="ob-icon"><i class="fa-solid fa-rocket"></i></span>
    <div class="ob-text">
      <strong>START HERE:</strong> Create a new investigation, add targets, then execute your OSINT run. Each investigation is isolated &mdash; switch between them from the Active Investigations panel.
    </div>
    <button class="ob-dismiss" onclick="dismissOnboarding()"><i class="fa-solid fa-xmark"></i> Dismiss</button>
  </div>

  <!-- STEP INDICATOR -->
  <div class="step-indicator" id="stepIndicator">
    <div class="step-item active" id="step1">
      <span class="step-num">1</span>
      <span>Create</span>
    </div>
    <div class="step-connector" id="conn1-2"></div>
    <div class="step-item" id="step2">
      <span class="step-num">2</span>
      <span>Add Targets</span>
    </div>
    <div class="step-connector" id="conn2-3"></div>
    <div class="step-item" id="step3">
      <span class="step-num">3</span>
      <span>Run</span>
    </div>
    <div class="step-connector" id="conn3-4"></div>
    <div class="step-item" id="step4">
      <span class="step-num">4</span>
      <span>Analyze</span>
    </div>
  </div>

  <!-- WELCOME BANNER -->
  <div class="welcome-banner hidden" id="welcomeBanner">
    <strong id="welcomeUser">Welcome back!</strong><br>
    <div class="wb-sub">Start by creating an investigation or try the DEMO. Add any targets you know (phone, email, name, domain), then search and let AI analyze the results.</div>
  </div>

  <!-- MY INVESTIGATIONS -->
  <div class="panel hidden" id="panelInvestigations" style="margin-bottom:1.5rem">
    <div class="panel-head">
      <span class="dot" style="background:var(--green)"></span>
      <span class="label"><i class="fa-solid fa-folder-open"></i> My Investigations</span>
    </div>
    <div class="panel-body">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
        <span class="text-dim text-sm">Select an investigation or start fresh</span>
        <button class="btn btn-red" id="btnNewInvestigation" onclick="newInvestigation()" style="font-size:.75rem;padding:.4rem .8rem">
          <i class="fa-solid fa-plus"></i> New Investigation
        </button>
      </div>
      <!-- Tabs: Active / History -->
      <div class="inv-tabs">
        <button class="inv-tab active" id="invTabActive" onclick="showInvTab('active')">
          <i class="fa-solid fa-folder-open"></i> Active <span class="tab-count" id="invActiveCount">0</span>
        </button>
        <button class="inv-tab" id="invTabHistory" onclick="showInvTab('history')">
          <i class="fa-solid fa-clock-rotate-left"></i> History <span class="tab-count" id="invHistoryCount">0</span>
        </button>
      </div>
      <div id="investigationsBody"></div>
      <div id="investigationsHistoryBody" class="hidden"></div>
      <div class="inv-clear-bar hidden" id="invClearBar">
        <span class="inv-persistence-note" id="invPersistNote">
          <i class="fa-solid fa-circle-info"></i>
          <span id="invPersistText">History saved this session only</span>
        </span>
        <button class="btn-delete-sm" onclick="clearAllHistory()" id="btnClearAll" style="padding:.3rem .6rem">
          <i class="fa-solid fa-trash"></i> Clear All History
        </button>
      </div>
    </div>
  </div>

  <!-- CURRENT INVESTIGATION CONTEXT -->
  <div class="current-inv-label hidden" id="currentInvLabel">
    <i class="fa-solid fa-folder-open" style="color:var(--green)"></i>
    <span>Active:</span>
    <span class="inv-name" id="currentInvName">--</span>
    <span class="inv-id" id="currentInvId"></span>
  </div>

  <!-- STATS ROW (current investigation only) -->
  <div class="stats-row" id="statsRow">
    <div class="stat-box"><div class="val" id="statEntities">0</div><div class="lbl"><i class="fa-solid fa-crosshairs"></i> Targets</div></div>
    <div class="stat-box"><div class="val" id="statFindings">0</div><div class="lbl"><i class="fa-solid fa-magnifying-glass"></i> Results</div></div>
    <div class="stat-box"><div class="val" id="statPatterns">0</div><div class="lbl"><i class="fa-solid fa-brain"></i> AI Insights</div></div>
    <div class="stat-box"><div class="val" id="statSeverity">--</div><div class="lbl"><i class="fa-solid fa-triangle-exclamation"></i> Max Severity</div></div>
  </div>

  <div class="grid">

    <!-- SECTION: STEP 1 — CREATE -->
    <div class="section-divider"><span class="sd-label"><span class="sd-num">1</span> Create Investigation</span></div>

    <!-- NEW INVESTIGATION -->
    <div class="panel" id="panelNewProject">
      <div class="panel-head">
        <span class="dot" style="background:var(--green)"></span>
        <span class="label"><i class="fa-solid fa-plus-circle"></i> New Investigation</span>
      </div>
      <div class="panel-body">
        <div class="field">
          <label>Investigation Name</label>
          <input type="text" id="projName" placeholder="Operation Nightfall">
        </div>
        <div class="field">
          <label>Target Description</label>
          <textarea id="projDesc" placeholder="Brief description of investigation targets and objectives..."></textarea>
        </div>
        <button class="btn btn-green btn-block gated-btn" id="btnCreateProject" onclick="createProject()">
          <i class="fa-solid fa-rocket"></i> Create Investigation
        </button>
        <div style="text-align:center;font-size:.75rem;color:var(--text-muted);margin-top:.5rem">Start a fresh case. Clears current targets and findings.</div>
        <div class="mt-1 text-center text-dim text-sm hidden" id="projectIdDisplay"></div>
      </div>
    </div>

    <!-- SECTION: STEP 2 — ADD TARGETS -->
    <div class="section-divider"><span class="sd-label"><span class="sd-num">2</span> Add Targets</span></div>

    <!-- TARGET ACQUISITION -->
    <div class="panel" id="panelTargets">
      <div class="panel-head">
        <span class="dot" style="background:var(--amber)"></span>
        <span class="label"><i class="fa-solid fa-crosshairs"></i> Add What You Know</span>
      </div>
      <div class="panel-body">
        <div class="field">
          <label>What type of info?</label>
          <select id="entityType">
            <option value="phone">Phone Number</option>
            <option value="email">Email Address</option>
            <option value="username">Username</option>
            <option value="domain">Domain</option>
            <option value="ip">IP Address</option>
            <option value="name">Name</option>
            <option value="social">Social Profile</option>
            <option value="file">File</option>
          </select>
        </div>
        <div class="field">
          <label>Target Value</label>
          <input type="text" id="entityValue" placeholder="e.g. +15551234567">
        </div>
        <div class="field">
          <label>Label (optional)</label>
          <input type="text" id="entityLabel" placeholder="e.g. Suspect primary phone">
        </div>
        <button class="btn btn-amber btn-block gated-btn" id="btnAddEntity" onclick="addEntity()" disabled>
          <i class="fa-solid fa-bullseye"></i> Add Target
        </button>
        <div style="text-align:center;font-size:.75rem;color:var(--text-muted);margin-top:.5rem">Enter phone, email, username, IP, or domain.</div>
        <ul class="entity-list" id="entityList"></ul>
        <div class="clear-targets-bar hidden" id="clearTargetsBar">
          <span class="targets-count" id="targetsCount">0 targets</span>
          <button class="btn-delete-sm" onclick="clearAllTargets()"><i class="fa-solid fa-trash"></i> Clear All Targets</button>
        </div>
      </div>
    </div>

    <!-- SECTION: STEP 3 — RUN -->
    <div class="section-divider"><span class="sd-label"><span class="sd-num">3</span> Search &amp; Analyze</span></div>

    <!-- EXECUTE RUN -->
    <div class="panel full-width" id="panelRun">
      <div class="panel-head">
        <span class="dot" style="background:var(--green)"></span>
        <span class="label"><i class="fa-solid fa-satellite-dish"></i> Intelligence Operations</span>
      </div>
      <div class="panel-body text-center">
        <div style="display:inline-flex;flex-direction:column;align-items:center;gap:.3rem;vertical-align:top">
          <button class="btn btn-red btn-lg gated-btn" id="btnRun" onclick="executeRun()" disabled title="Select an investigation first">
            <i class="fa-solid fa-play"></i> Search &amp; Gather Info
          </button>
          <span style="font-size:.7rem;color:var(--text-muted)">Searches public sources (phone, breach, domain, etc.)</span>
        </div>
        <div style="display:inline-flex;flex-direction:column;align-items:center;gap:.3rem;vertical-align:top;margin-left:1rem">
          <button class="btn btn-cyan btn-lg gated-btn" id="btnAnalyze" onclick="runAnalysis()" disabled title="Select an investigation first">
            <i class="fa-solid fa-brain"></i> Run AI Analysis
            <span style="font-size:.6rem;background:var(--amber);color:#000;padding:.1rem .4rem;border-radius:2px;margin-left:.4rem;letter-spacing:.08em">PREMIUM</span>
          </button>
          <span style="font-size:.7rem;color:var(--text-muted)">AI finds patterns &amp; risks. Free&nbsp;=&nbsp;basic summary. Premium&nbsp;=&nbsp;full&nbsp;report.</span>
        </div>
        <div class="run-status" id="runStatus">
          <span class="blink">&#x2588;</span> <i class="fa-solid fa-spinner fa-spin"></i> Searching...
        </div>
        <div class="run-status" id="analyzeStatus">
          <span class="blink">&#x2588;</span> <i class="fa-solid fa-spinner fa-spin"></i> Analyzing with AI...
        </div>

        <!-- AI Analysis Example Preview (always visible) -->
        <div class="ai-example-preview" id="aiExamplePreview">
          <div class="example-label"><i class="fa-solid fa-eye"></i> Example: What AI Analysis Looks Like</div>
          <div class="example-card">
            <div class="ex-type"><i class="fa-solid fa-file-lines"></i> Summary</div>
            <div class="ex-desc">Target +1-555-0142 is a VoIP line registered through Twilio, linked to 3 online identities across LinkedIn, GitHub, and a Shopify storefront. Activity cluster suggests a freelance developer persona.</div>
          </div>
          <div class="example-card ex-anomaly">
            <div class="ex-type"><i class="fa-solid fa-triangle-exclamation"></i> Anomaly</div>
            <div class="ex-desc">Phone registered in TX but social profiles list SF. Domain WHOIS shows a third address in FL. Geographic spread inconsistent with single-individual pattern.</div>
          </div>
          <div class="example-card ex-lead">
            <div class="ex-type"><i class="fa-solid fa-lightbulb"></i> Investigative Lead</div>
            <div class="ex-desc">GitHub commit emails match a breach record from 2021. Cross-reference with the Shopify store owner email for identity confirmation.</div>
          </div>
        </div>
        <div class="ai-premium-gate" id="aiPremiumGate">
          <div class="gate-title"><i class="fa-solid fa-lock"></i> AI Analysis &mdash; Premium Feature</div>
          <div class="gate-desc">Deep pattern detection, risk scoring, entity linking, anomaly alerts, and investigative leads. Powered by local LLM &mdash; your data never leaves the server.</div>
          <button class="btn btn-amber btn-lg" onclick="showPaywall()"><i class="fa-solid fa-bolt"></i> Unlock AI Analysis &mdash; $9.99/mo</button>
        </div>
      </div>
    </div>

    <!-- SECTION: STEP 4 — RESULTS -->
    <div class="section-divider"><span class="sd-label"><span class="sd-num">4</span> Results &amp; Analysis</span></div>

    <!-- FINDINGS (collapsible, collapsed by default) -->
    <div class="panel full-width panel-collapsible collapsed hidden" id="panelFindings">
      <div class="panel-head" onclick="togglePanel('panelFindings')">
        <span class="dot" style="background:var(--cyan)"></span>
        <span class="label"><i class="fa-solid fa-file-shield"></i> Intelligence Findings</span>
        <span class="collapse-badge" id="findingsCount">0</span>
        <span class="collapse-chevron"><i class="fa-solid fa-chevron-down"></i></span>
      </div>
      <div class="panel-body">
        <div class="findings-grid" id="findingsGrid"></div>
      </div>
    </div>

    <!-- ANALYSIS / PATTERNS (collapsible, collapsed by default) -->
    <div class="panel full-width panel-collapsible collapsed hidden" id="panelPatterns">
      <div class="panel-head" onclick="togglePanel('panelPatterns')">
        <span class="dot" style="background:var(--amber)"></span>
        <span class="label"><i class="fa-solid fa-diagram-project"></i> AI Analysis &mdash; Patterns &amp; Insights</span>
        <span class="collapse-badge" id="patternsCount">0</span>
        <span class="collapse-chevron"><i class="fa-solid fa-chevron-down"></i></span>
      </div>
      <div class="panel-body" id="patternsContainer"></div>
    </div>

  </div><!-- /grid -->

  <!-- PLATFORM STATS (from backend aggregate) -->
  <div class="panel mt-2" id="panelPlatformStats" style="margin-bottom:1rem">
    <div class="panel-head">
      <span class="dot" style="background:var(--cyan)"></span>
      <span class="label"><i class="fa-solid fa-chart-bar"></i> Platform Usage (Anonymous Aggregate)</span>
    </div>
    <div class="panel-body" id="platformStatsBody" style="font-size:.85rem;color:var(--text-dim);text-align:center">
      Loading aggregate stats...
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="site-footer">
    VALKYRIE OSINT v2.0 | Built by Travis (@L7Dare)<br>
    <span class="upgrade-hint" id="footerUpgrade">Free Tier Active &mdash; <a href="#" onclick="showPaywall();return false" style="color:var(--amber);text-decoration:underline">Upgrade to Premium</a> for Unlimited Runs &amp; Advanced Sources</span>
    <br><span style="font-size:.7rem;color:var(--text-muted);margin-top:.3rem;display:inline-block"><a href="#" onclick="optOutStats();return false" style="color:var(--text-muted)">Opt-out of anonymous stats</a></span>
  </footer>

</div><!-- /container -->

<!-- TERMINAL -->
<div class="terminal" id="terminal">
  <div class="terminal-head">
    <span class="label"><i class="fa-solid fa-terminal"></i> System Log</span>
    <button class="terminal-toggle" onclick="toggleTerminal()">[ _ ]</button>
  </div>
  <div class="terminal-body" id="terminalBody"></div>
</div>

<!-- PayPal SDK (placeholder client-id — replace with your real one) -->
<script src="https://www.paypal.com/sdk/js?client-id=PLACEHOLDER_CLIENT_ID&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

<script>
/* ─── State ─── */
let projectId = null;
let entities = [];

/* ─── Ethical Disclaimer Gate ─── */
function isDisclaimerAcknowledged(){
  return localStorage.getItem('vk_ethical_ack') === '1';
}

function initDisclaimerGate(){
  const disclaimer = document.getElementById('ethicalDisclaimer');
  const checkbox = document.getElementById('ethicalAckCheck');

  if(isDisclaimerAcknowledged()){
    disclaimer.classList.add('acknowledged');
    enableGatedButtons();
    return;
  }

  // Disable all gated buttons until acknowledged
  disableGatedButtons();

  checkbox.addEventListener('change', function(){
    if(checkbox.checked){
      localStorage.setItem('vk_ethical_ack', '1');
      disclaimer.classList.add('acknowledged');
      enableGatedButtons();
      log('Ethical use policy acknowledged', 'system');
    }
  });
}

function disableGatedButtons(){
  document.querySelectorAll('.gated-btn').forEach(function(btn){
    btn.classList.add('gated');
  });
}

function enableGatedButtons(){
  document.querySelectorAll('.gated-btn').forEach(function(btn){
    btn.classList.remove('gated');
  });
}

/* ─── Why Premium Toggle ─── */
function toggleWhyPremium(){
  document.getElementById('whyPremium').classList.toggle('open');
}

/* ─── AI Teaser Overlay ─── */
function showAiTeaser(basicSummary){
  document.getElementById('aiTeaserContent').textContent = basicSummary || 'Target entities analyzed. Basic pattern overview generated.';
  document.getElementById('aiTeaserOverlay').classList.remove('hidden');
}
function closeAiTeaser(){
  document.getElementById('aiTeaserOverlay').classList.add('hidden');
}

/* ─── Aggregate Stats (no PII) ─── */
const aggStats = {
  total_runs: parseInt(localStorage.getItem('vk_agg_total_runs') || '0'),
  target_types: JSON.parse(localStorage.getItem('vk_agg_target_types') || '{}'),
  errors: parseInt(localStorage.getItem('vk_agg_errors') || '0'),
  total_analyses: parseInt(localStorage.getItem('vk_agg_total_analyses') || '0')
};
function saveAggStats(){
  localStorage.setItem('vk_agg_total_runs', String(aggStats.total_runs));
  localStorage.setItem('vk_agg_target_types', JSON.stringify(aggStats.target_types));
  localStorage.setItem('vk_agg_errors', String(aggStats.errors));
  localStorage.setItem('vk_agg_total_analyses', String(aggStats.total_analyses));
}
function recordRun(entityTypes){
  if(localStorage.getItem('vk_stats_optout')==='1') return;
  aggStats.total_runs++;
  (entityTypes||[]).forEach(t=>{aggStats.target_types[t]=(aggStats.target_types[t]||0)+1});
  saveAggStats();
}
function recordError(){
  if(localStorage.getItem('vk_stats_optout')==='1') return;
  aggStats.errors++;
  saveAggStats();
}
function recordAnalysis(){
  if(localStorage.getItem('vk_stats_optout')==='1') return;
  aggStats.total_analyses++;
  saveAggStats();
}
function optOutStats(){
  localStorage.setItem('vk_stats_optout','1');
  alert('Opted out of anonymous aggregate stats. No further data will be recorded.');
}

/* ─── Freemium System ─── */
const FREE_DAILY_LIMIT = 5;
function getRunCount(){
  const stored = localStorage.getItem('vk_run_counter');
  if(stored){
    const data = JSON.parse(stored);
    const today = new Date().toISOString().slice(0,10);
    if(data.date === today) return data.count;
  }
  return 0;
}
function incrementRunCount(){
  const today = new Date().toISOString().slice(0,10);
  const count = getRunCount() + 1;
  localStorage.setItem('vk_run_counter', JSON.stringify({date:today, count}));
  updateFreemiumUI();
  return count;
}
function isAdmin(){
  return currentUser && currentUser.email === 'tcmherd@proton.me';
}
function isPremium(){
  if(isAdmin()) return true;
  // Only premium if server tier says so OR PayPal subscription confirmed in this session
  if(currentUser && currentUser.tier === 'premium') return true;
  return localStorage.getItem('vk_isPremium') === 'true';
}
function canRun(){
  if(isAdmin()) return true;
  if(isPremium()) return true;
  return getRunCount() < FREE_DAILY_LIMIT;
}
function updateFreemiumUI(){
  const bar = document.getElementById('freemiumBar');
  const text = document.getElementById('runsLeftText');
  const prog = document.getElementById('runsProgress');
  const btnUp = document.getElementById('btnUpgradeSmall');
  const footerUp = document.getElementById('footerUpgrade');
  const wpSection = document.getElementById('whyPremium');
  const adminBanner = document.getElementById('adminBanner');

  if(isAdmin()){
    if(adminBanner) adminBanner.classList.remove('hidden');
    bar.classList.add('hidden');
    footerUp.innerHTML = '<span style="color:var(--red)"><i class="fa-solid fa-shield-halved"></i> Admin Mode &mdash; Unlimited Access</span>';
    if(wpSection) wpSection.classList.add('hidden');
    updateAiPremiumUI();
    return;
  }
  if(adminBanner) adminBanner.classList.add('hidden');

  if(isPremium()){
    bar.classList.remove('hidden');
    text.innerHTML = '<span class="premium-badge"><i class="fa-solid fa-crown"></i> PREMIUM ACTIVE &mdash; UNLIMITED</span>';
    prog.style.width = '100%';
    prog.style.background = 'var(--green)';
    prog.style.boxShadow = '0 0 8px rgba(0,255,0,.5)';
    btnUp.classList.add('hidden');
    bar.style.borderColor = 'rgba(0,255,0,.25)';
    bar.style.background = 'rgba(0,255,0,.05)';
    footerUp.innerHTML = '<span style="color:var(--green)"><i class="fa-solid fa-crown"></i> Premium Active &mdash; Unlimited Runs &amp; Full AI</span>';
    if(wpSection) wpSection.classList.add('hidden');
    updateAiPremiumUI();
    return;
  }

  bar.classList.remove('hidden');
  if(wpSection) wpSection.classList.remove('hidden');
  const used = getRunCount();
  const left = Math.max(0, FREE_DAILY_LIMIT - used);
  const pct = Math.round((left / FREE_DAILY_LIMIT) * 100);

  text.className = 'runs-left';
  text.style.color = '';
  text.textContent = left + '/' + FREE_DAILY_LIMIT + ' free runs left today';
  prog.style.width = pct + '%';
  prog.style.boxShadow = '';

  if(left === 0){
    prog.style.background = 'var(--red)';
    text.style.color = 'var(--red)';
    prog.style.boxShadow = '0 0 6px rgba(255,0,0,.4)';
    btnUp.classList.remove('hidden');
  } else if(left <= 2){
    prog.style.background = 'var(--amber)';
    text.className = 'runs-left runs-low';
    btnUp.classList.remove('hidden');
  } else {
    prog.style.background = 'var(--green)';
    prog.style.boxShadow = '0 0 6px rgba(0,255,0,.3)';
    btnUp.classList.remove('hidden');
  }

  footerUp.innerHTML = 'Free Tier: <strong style="color:var(--amber)">'
    + left + '/' + FREE_DAILY_LIMIT + ' runs left today</strong> &mdash; '
    + '<a href="#" onclick="showPaywall();return false" style="color:var(--amber);text-decoration:underline">Upgrade to Premium</a>'
    + ' for Unlimited Runs &amp; Full AI';

  updateAiPremiumUI();
}

/* ─── PayPal / Paywall ─── */
function showPaywall(){
  document.getElementById('paywallOverlay').classList.remove('hidden');
  renderPayPalButton();
}
function closePaywall(){
  document.getElementById('paywallOverlay').classList.add('hidden');
}
let paypalRendered = false;
function renderPayPalButton(){
  if(paypalRendered) return;
  if(typeof paypal === 'undefined'){
    document.getElementById('paypal-button-container').innerHTML = '<p style="color:var(--text-dim);font-size:.8rem">PayPal SDK loading... Refresh if needed.</p>';
    return;
  }
  paypalRendered = true;
  paypal.Buttons({
    style: {shape:'rect', color:'gold', layout:'vertical', label:'subscribe'},
    createSubscription: function(data, actions){
      return actions.subscription.create({
        plan_id: 'PLACEHOLDER_PLAN_ID'  // Replace with your real PayPal plan ID
      });
    },
    onApprove: function(data){
      localStorage.setItem('vk_isPremium', 'true');
      updateFreemiumUI();
      closePaywall();
      log('Premium subscription activated!', 'info');
      alert('Premium activated! You now have unlimited runs.');
    },
    onError: function(err){
      log('PAYPAL ERROR: ' + err, 'error');
    }
  }).render('#paypal-button-container');
}

/* ─── Pay-Per-Report ─── */
function isReportUnlocked(pid){
  const unlocked = JSON.parse(localStorage.getItem('vk_unlocked_reports') || '[]');
  return unlocked.includes(pid);
}
function unlockReport(pid){
  const unlocked = JSON.parse(localStorage.getItem('vk_unlocked_reports') || '[]');
  if(!unlocked.includes(pid)) unlocked.push(pid);
  localStorage.setItem('vk_unlocked_reports', JSON.stringify(unlocked));
}
function showReportPay(){
  document.getElementById('reportPayOverlay').classList.remove('hidden');
  renderReportPayPalButton();
}
function closeReportPay(){
  document.getElementById('reportPayOverlay').classList.add('hidden');
}
let reportPaypalRendered = false;
function renderReportPayPalButton(){
  if(reportPaypalRendered) return;
  if(typeof paypal === 'undefined'){
    document.getElementById('report-paypal-container').innerHTML = '<p style="color:var(--text-dim);font-size:.8rem">PayPal SDK loading... Refresh if needed.</p>';
    return;
  }
  reportPaypalRendered = true;
  paypal.Buttons({
    style: {shape:'rect', color:'silver', layout:'vertical', label:'pay'},
    createOrder: function(data, actions){
      return actions.order.create({
        purchase_units: [{
          description: 'VALKYRIE OSINT Full Detailed Report',
          amount: {value: '4.99', currency_code: 'USD'}
        }]
      });
    },
    onApprove: function(data, actions){
      return actions.order.capture().then(function(details){
        if(projectId) unlockReport(projectId);
        closeReportPay();
        log('Report unlocked for this investigation', 'info');
        alert('Report unlocked! Loading full analysis...');
        loadPatterns();
      });
    },
    onError: function(err){
      log('PAYPAL REPORT ERROR: ' + err, 'error');
    }
  }).render('#report-paypal-container');
}

/* ─── Consent ─── */
function checkConsent(){
  if(localStorage.getItem('vk_consent_accepted') !== '1'){
    document.getElementById('consentOverlay').classList.remove('hidden');
  }
}
function acceptConsent(){
  if(!document.getElementById('consentCheck').checked) return;
  localStorage.setItem('vk_consent_accepted', '1');
  document.getElementById('consentOverlay').classList.add('hidden');
  log('Anonymous usage logging enabled', 'system');
}
document.addEventListener('DOMContentLoaded', function(){
  const cb = document.getElementById('consentCheck');
  cb.addEventListener('change', function(){
    document.getElementById('btnConsent').disabled = !cb.checked;
  });
  initDisclaimerGate();
});

/* ─── Mission Clock ─── */
function updateMissionClock(){
  const now=new Date();
  const local=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');
  const zulu=now.toISOString().slice(11,19);
  document.getElementById('mcLocal').textContent=local;
  document.getElementById('mcZulu').textContent=zulu;
}
setInterval(updateMissionClock,1000);updateMissionClock();

/* ─── OPSEC Threat Meter ─── */
function setThreatLevel(level){
  const el=document.getElementById('opsecThreat');
  const lbl=document.getElementById('threatLevel');
  lbl.textContent=level.toUpperCase();
  el.className='threat-meter threat-'+level.toLowerCase();
}
function computeThreat(findings){
  if(!findings||!findings.length){setThreatLevel('minimal');return}
  const sevW={info:0,low:1,medium:2,high:4,critical:8,error:0};
  let score=0;
  findings.forEach(f=>{score+=(sevW[f.severity]||0)});
  if(score>=20) setThreatLevel('critical');
  else if(score>=12) setThreatLevel('high');
  else if(score>=6) setThreatLevel('elevated');
  else if(score>=2) setThreatLevel('guarded');
  else setThreatLevel('minimal');
}
setThreatLevel('elevated');

/* ─── Account Dropdown ─── */
(function initDossier(){
  const emailEl=document.getElementById('userEmail');
  const dropdown=document.getElementById('dossierDropdown');
  if(!emailEl||!dropdown) return;
  emailEl.addEventListener('click',function(e){
    e.stopPropagation();
    dropdown.classList.toggle('hidden');
  });
  document.addEventListener('click',function(e){
    if(!emailEl.contains(e.target)&&!dropdown.contains(e.target)){
      dropdown.classList.add('hidden');
    }
  });
})();

/* ─── Terminal Log ─── */
let _lastLogMsg='',_lastLogCount=0,_lastLogEl=null;
function log(msg,type='info'){
  const d=new Date();
  const ts=String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')+':'+String(d.getSeconds()).padStart(2,'0');
  const body=document.getElementById('terminalBody');
  if(msg===_lastLogMsg&&_lastLogEl){
    _lastLogCount++;
    _lastLogEl.textContent='['+ts+'] '+msg+' (x'+_lastLogCount+')';
    body.scrollTop=body.scrollHeight;
    return;
  }
  _lastLogMsg=msg;_lastLogCount=1;
  const el=document.createElement('div');
  el.className='log-line '+type;
  el.textContent='['+ts+'] '+msg;
  _lastLogEl=el;
  body.appendChild(el);
  body.scrollTop=body.scrollHeight;
}
function toggleTerminal(){
  document.getElementById('terminal').classList.toggle('collapsed');
}

/* ─── Auth State ─── */
let authToken=sessionStorage.getItem('jwt_token')||null;
let currentUser=null;

function getAuthHeader(){
  if(!authToken) throw new Error('Not authenticated');
  return 'Bearer '+authToken;
}

/* ─── Auth UI ─── */
function showAuthTab(tab){
  document.getElementById('tabLogin').classList.toggle('active',tab==='login');
  document.getElementById('tabRegister').classList.toggle('active',tab==='register');
  document.getElementById('loginForm').classList.toggle('hidden',tab!=='login');
  document.getElementById('registerForm').classList.toggle('hidden',tab!=='register');
  document.getElementById('authError').style.display='none';
  document.getElementById('authInfo').style.display='none';
}

function showAuthError(msg){
  const el=document.getElementById('authError');
  el.textContent=msg;el.style.display='block';
  document.getElementById('authInfo').style.display='none';
}

function showAuthInfo(msg){
  const el=document.getElementById('authInfo');
  el.textContent=msg;el.style.display='block';
  document.getElementById('authError').style.display='none';
}

async function doRegister(){
  const email=document.getElementById('regEmail').value.trim();
  const pw=document.getElementById('regPassword').value;
  const pw2=document.getElementById('regPassword2').value;
  if(!email||!pw){showAuthError('Email and password required');return}
  if(pw!==pw2){showAuthError('Passwords do not match');return}
  if(pw.length<6){showAuthError('Password must be at least 6 characters');return}
  try{
    const res=await fetch('/api/v1/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pw})});
    if(!res.ok){const d=await res.json();throw new Error(d.detail||'Registration failed')}
    showAuthInfo('Account created. You can now log in.');
    showAuthTab('login');
    document.getElementById('loginEmail').value=email;
  }catch(e){showAuthError(e.message)}
}

async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pw=document.getElementById('loginPassword').value;
  if(!email||!pw){showAuthError('Email and password required');return}
  try{
    const body=new URLSearchParams();
    body.append('username',email);
    body.append('password',pw);
    const res=await fetch('/api/v1/auth/login',{method:'POST',body});
    if(!res.ok){const d=await res.json();throw new Error(d.detail||'Login failed')}
    const data=await res.json();
    authToken=data.access_token;
    sessionStorage.setItem('jwt_token',authToken);
    await onAuthSuccess();
  }catch(e){showAuthError(e.message)}
}

function doLogout(){
  authToken=null;currentUser=null;
  sessionStorage.removeItem('jwt_token');
  sessionStorage.removeItem('projectId');
  document.getElementById('authOverlay').classList.remove('hidden');
  document.getElementById('userBar').classList.add('hidden');
  document.getElementById('dossierDropdown').classList.add('hidden');
  document.getElementById('welcomeBanner').classList.add('hidden');
  setThreatLevel('elevated');
  log('Logged out','warn');
}

async function onAuthSuccess(){
  try{
    const res=await fetch('/api/v1/auth/me',{headers:{'Authorization':'Bearer '+authToken}});
    if(!res.ok) throw new Error('Token invalid');
    currentUser=await res.json();
  }catch(e){
    authToken=null;sessionStorage.removeItem('jwt_token');
    showAuthError('Session expired. Please log in again.');
    return;
  }
  document.getElementById('authOverlay').classList.add('hidden');
  document.getElementById('userBar').classList.remove('hidden');
  document.getElementById('userEmail').textContent=currentUser.email;
  document.getElementById('userTier').textContent=currentUser.tier.toUpperCase();
  log('Logged in as '+currentUser.email+' ('+currentUser.tier+' plan)','system');
  const wb=document.getElementById('welcomeBanner');
  wb.classList.remove('hidden');
  document.getElementById('welcomeUser').innerHTML='Welcome back, '+esc(currentUser.email)+'!';
  document.getElementById('dossierClearance').textContent=currentUser.email;
  document.getElementById('dossierTier').textContent=currentUser.tier.charAt(0).toUpperCase()+currentUser.tier.slice(1);
  document.getElementById('dossierSession').textContent=authToken?authToken.slice(-12).toUpperCase():'----';
  document.getElementById('dossierLogin').textContent=new Date().toLocaleString();
  // Clear stale premium flag — only set if server confirms premium tier
  if(currentUser.tier === 'premium'){
    localStorage.setItem('vk_isPremium', 'true');
  } else if(!isAdmin()){
    localStorage.removeItem('vk_isPremium');
  }
  // Admin unlimited access
  if(isAdmin()){
    document.getElementById('userTier').textContent='ADMIN';
    document.getElementById('userTier').style.background='rgba(255,0,0,.15)';
    document.getElementById('userTier').style.color='var(--red)';
    document.getElementById('userTier').style.borderColor='var(--red-dim)';
    document.getElementById('dossierTier').textContent='Admin (Unlimited)';
    log('Admin mode: full access enabled','system');
  }
  updateFreemiumUI(); // sets admin banner, run counter, etc.
  migrateHistoryOnUpgrade();
  checkConsent();
  showOnboardingIfNeeded();
  loadInvestigations();
}

/* ─── API Helper ─── */
async function api(method,path,body,auth){
  const opts={method,headers:{'Content-Type':'application/json'}};
  if(auth) opts.headers['Authorization']=getAuthHeader();
  if(body) opts.body=JSON.stringify(body);
  const res=await fetch('/api/v1'+path,opts);
  if(res.status===401){
    authToken=null;sessionStorage.removeItem('jwt_token');
    document.getElementById('authOverlay').classList.remove('hidden');
    throw new Error('Session expired — please log in again');
  }
  if(!res.ok){
    let errMsg='HTTP '+res.status;
    try{const j=await res.json();errMsg=j.detail||JSON.stringify(j)}catch(e){}
    throw new Error(errMsg);
  }
  if(res.status===204) return null;
  return res.json();
}

/* ─── Create Project ─── */
async function createProject(){
  if(!isDisclaimerAcknowledged()){log('ERROR: Acknowledge the ethical use disclaimer first','error');return}
  const name=document.getElementById('projName').value.trim();
  const desc=document.getElementById('projDesc').value.trim();
  if(!name){log('ERROR: Investigation name is required','error');return}
  const btn=document.getElementById('btnCreateProject');
  btn.disabled=true;
  log('Creating investigation "'+name+'"...','system');
  try{
    const data=await api('POST','/projects',{name,description:desc,target_summary:desc});
    projectId=data.id;
    sessionStorage.setItem('projectId',data.id);
    log('Investigation created: '+projectId,'info');
    document.getElementById('projectIdDisplay').textContent='Project ID: '+projectId;
    document.getElementById('projectIdDisplay').classList.remove('hidden');
    // Show current investigation label
    document.getElementById('currentInvLabel').classList.remove('hidden');
    document.getElementById('currentInvName').textContent=name;
    document.getElementById('currentInvId').textContent='['+data.id.slice(0,8)+']';
    document.getElementById('btnAddEntity').disabled=false;
    document.getElementById('btnRun').disabled=false;
    document.getElementById('btnRun').removeAttribute('title');
    document.getElementById('statsRow').classList.remove('hidden');
    btn.innerHTML='<i class="fa-solid fa-check"></i> Project Active';
    setStep(2);
    addToHistory(data.id, name, [], 'Investigation created');
    loadInvestigations();
  }catch(e){
    log('ERROR: '+e.message,'error');
    recordError();
    btn.disabled=false;
  }
}

/* ─── Add Entity ─── */
async function addEntity(){
  if(!isDisclaimerAcknowledged()){log('ERROR: Acknowledge the ethical use disclaimer first','error');return}
  if(!projectId){log('ERROR: Create a project first','error');return}
  const etype=document.getElementById('entityType').value;
  const val=document.getElementById('entityValue').value.trim();
  const label=document.getElementById('entityLabel').value.trim();
  if(!val){log('ERROR: Target value is required','error');return}
  log('Adding target: '+etype+' = '+val,'system');
  try{
    const body={entity_type:etype,value:val};
    if(label) body.label=label;
    const data=await api('POST','/projects/'+projectId+'/entities',body);
    entities.push(data);
    renderEntityList();
    updateStats();
    document.getElementById('entityValue').value='';
    document.getElementById('entityLabel').value='';
    log('Target added: '+etype+' / '+val,'info');
    if(currentStep<3) setStep(3);
  }catch(e){
    log('ERROR: '+e.message,'error');
    recordError();
  }
}

function renderEntityList(){
  const ul=document.getElementById('entityList');
  ul.innerHTML='';
  entities.forEach((ent)=>{
    const li=document.createElement('li');
    li.className='entity-item';
    li.innerHTML='<span style="flex:1;min-width:0"><span class="etype">'+esc(ent.entity_type)+'</span><span class="eval" style="word-break:break-all">'+esc(ent.value)+'</span>'+(ent.label?'<span style="color:var(--text-muted);font-size:.7rem;margin-left:.4rem">('+esc(ent.label)+')</span>':'')+'</span>'
      +'<span style="display:flex;align-items:center;gap:.4rem;flex-shrink:0">'
      +'<span class="entity-status '+(ent.status||'pending')+'">'+(ent.status||'pending')+'</span>'
      +'<button class="remove" onclick="deleteEntity(\''+ent.id+'\')" title="Remove target"><i class="fa-solid fa-xmark"></i></button>'
      +'</span>';
    ul.appendChild(li);
  });
  // Show/hide clear bar
  const bar=document.getElementById('clearTargetsBar');
  const cnt=document.getElementById('targetsCount');
  if(entities.length>0){
    bar.classList.remove('hidden');
    cnt.textContent=entities.length+' target'+(entities.length===1?'':'s');
  }else{
    bar.classList.add('hidden');
  }
  updateStats();
}

async function deleteEntity(entityId){
  if(!projectId) return;
  try{
    await api('DELETE','/projects/'+projectId+'/entities/'+entityId);
    entities=entities.filter(e=>e.id!==entityId);
    renderEntityList();
    log('Target removed','warn');
  }catch(e){
    log('DELETE TARGET ERROR: '+e.message,'error');
  }
}

async function clearAllTargets(){
  if(!projectId||entities.length===0) return;
  if(!confirm('Remove all '+entities.length+' targets from this investigation?')) return;
  for(const ent of [...entities]){
    try{
      await api('DELETE','/projects/'+projectId+'/entities/'+ent.id);
    }catch(e){}
  }
  entities=[];
  renderEntityList();
  log('All targets removed from this investigation','warn');
}

/* ─── Execute OSINT Run ─── */
async function executeRun(){
  if(!isDisclaimerAcknowledged()){log('ERROR: Acknowledge the ethical use disclaimer first','error');return}
  if(!projectId){log('ERROR: No active project','error');return}
  if(entities.length===0){log('ERROR: Add at least one target first','error');return}

  // Freemium gate
  if(!canRun()){
    log('Daily free search limit reached. Upgrade to Premium for more.','warn');
    showPaywall();
    return;
  }

  const btn=document.getElementById('btnRun');
  btn.disabled=true;
  document.getElementById('runStatus').classList.add('active');
  log('Starting search...','warn');

  // Record aggregate stats and decrement daily quota
  const entityTypes = entities.map(e => e.entity_type);
  if(!isAdmin() && !isPremium()) incrementRunCount();
  recordRun(entityTypes);

  try{
    const data=await api('POST','/projects/'+projectId+'/run',null,true);
    log('Search complete: '+data.entities_processed+' target(s) processed, '+data.findings_created+' results found','info');
    document.getElementById('runStatus').classList.remove('active');
    await refreshProject();
    await loadFindings();
    loadPlatformStats();
    btn.disabled=false;
    document.getElementById('btnAnalyze').disabled=false;
    setStep(4);
    // Add to investigation history
    const invName=document.getElementById('currentInvName').textContent||'Unknown';
    const targets=entities.map(e=>({type:e.entity_type,value:e.value}));
    const findingsCount=document.getElementById('statFindings').textContent;
    addToHistory(projectId, invName, targets, findingsCount+' findings collected');
  }catch(e){
    log('Search error: '+e.message,'error');
    recordError();
    document.getElementById('runStatus').classList.remove('active');
    btn.disabled=false;
  }
}

/* ─── Refresh project data ─── */
async function refreshProject(){
  if(!projectId) return;
  try{
    const data=await api('GET','/projects/'+projectId);
    const entData=await api('GET','/projects/'+projectId+'/entities');
    entities=entData;
    renderEntityList();
    updateStats(data);
  }catch(e){
    log('REFRESH ERROR: '+e.message,'error');
  }
}

function updateStats(projectData){
  document.getElementById('statEntities').textContent=entities.length;
  if(projectData){
    document.getElementById('statFindings').textContent=projectData.entity_count!==undefined?document.getElementById('statFindings').textContent:0;
  }
}

/* ─── Load Findings ─── */
async function loadFindings(){
  if(!projectId) return;
  log('Loading results...','system');
  try{
    const report=await api('GET','/projects/'+projectId+'/report');
    const allFindings=[];
    let maxSev='info';
    const sevOrder={error:0,info:1,low:2,medium:3,high:4,critical:5};

    (report.entities||[]).forEach(ent=>{
      (ent.findings||[]).forEach(f=>{
        f._entity_type=ent.entity_type;
        f._entity_value=ent.value;
        allFindings.push(f);
        if((sevOrder[f.severity]||0)>(sevOrder[maxSev]||0)) maxSev=f.severity;
      });
    });

    document.getElementById('statFindings').textContent=report.summary?report.summary.total_findings:allFindings.length;
    document.getElementById('statPatterns').textContent=report.summary?report.summary.total_patterns:0;
    document.getElementById('statSeverity').textContent=maxSev.toUpperCase();

    if(allFindings.length>0){
      const fp=document.getElementById('panelFindings');
      fp.classList.remove('hidden','collapsed');
      document.getElementById('findingsCount').textContent=allFindings.length;
      renderFindings(allFindings);
      log(allFindings.length+' result(s) loaded','info');
      computeThreat(allFindings);
      if(currentStep<4) setStep(4);
    }else{
      log('No results found yet — run a search first','warn');
      computeThreat([]);
    }
  }catch(e){
    log('FINDINGS ERROR: '+e.message,'error');
  }
}

function renderFindings(findings){
  const grid=document.getElementById('findingsGrid');
  grid.innerHTML='';
  findings.forEach(f=>{
    const card=document.createElement('div');
    card.className='finding-card sev-'+(f.severity||'info');

    const _PREMIUM_TOOLS=['IP-Geo','DomainRep','EmailRep','NameOSINT','HaveIBeenPwned'];
    const _TOOL_LABELS={'holehe':'Account Checker','haveibeenpwned':'Data Breach Check','emailrep':'Email Reputation','virustotal':'Virus / Malware Scan','whois':'Domain Registration Info','dnslookup':'DNS Lookup','ip-geo':'IP Location & Network','domainrep':'Domain Reputation','nameosint':'Social Media Search','numverify':'Phone Carrier Lookup','sherlock':'Username Search'};
    const isPremiumTool=_PREMIUM_TOOLS.some(t=>new RegExp(t,'i').test(f.tool_name||''));
    const toolKey=(f.tool_name||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const toolLabel=_TOOL_LABELS[toolKey]||_TOOL_LABELS[Object.keys(_TOOL_LABELS).find(k=>toolKey.includes(k))||'']||f.tool_name||'Unknown Tool';
    let html='<div class="finding-tool"><i class="fa-solid fa-wrench"></i> '+esc(toolLabel)+(isPremiumTool?'<span class="premium-badge"><i class="fa-solid fa-star"></i> premium</span>':'')+'</div>';
    html+='<div class="finding-severity">'+(f.severity||'info')+'</div>';
    html+='<div class="finding-summary">'+esc(f.summary||'No summary available')+'</div>';
    html+='<div class="finding-entity"><i class="fa-solid fa-crosshairs"></i> Target: '+esc(f._entity_value)+'</div>';

    if(f.tags&&f.tags.length){
      html+='<div class="finding-meta">';
      f.tags.forEach(t=>{html+='<span class="tag">'+esc(t)+'</span>'});
      html+='</div>';
    }

    const raw=f.raw_data||{};
    let actions='';

    if(raw.google_maps_url){
      actions+='<a class="btn btn-amber" href="'+esc(raw.google_maps_url)+'" target="_blank" rel="noopener"><i class="fa-solid fa-map-pin"></i> View Location</a>';
    }
    if(raw.gps_decimal){
      const coords=raw.gps_decimal;
      const mapsUrl='https://www.google.com/maps?q='+encodeURIComponent(coords);
      actions+='<a class="btn btn-amber" href="'+esc(mapsUrl)+'" target="_blank" rel="noopener"><i class="fa-solid fa-map-pin"></i> View Location</a>';
    }

    if(raw.found_on&&raw.found_on.length){
      html+='<div class="platforms-list"><strong>Found on:</strong><br>';
      raw.found_on.forEach(p=>{html+='<span>'+esc(p)+'</span>'});
      html+='</div>';
    }
    if(raw.platforms_found&&raw.platforms_found.length){
      html+='<div class="platforms-list"><strong>Platforms:</strong><br>';
      raw.platforms_found.forEach(p=>{html+='<span>'+esc(typeof p==='string'?p:p.name||p.url||JSON.stringify(p))+'</span>'});
      html+='</div>';
    }

    if(raw.breach_names&&raw.breach_names.length){
      html+='<div class="platforms-list"><strong>Breaches:</strong><br>';
      raw.breach_names.forEach(b=>{html+='<span>'+esc(b)+'</span>'});
      html+='</div>';
    }

    if(actions){
      html+='<div class="finding-actions">'+actions+'</div>';
    }

    // NumVerify enhanced rendering
    if(/numverify/i.test(f.tool_name)){
      const sum=f.summary||'';
      if(raw.skipped||/skip|no.*key|not.*configured/i.test(sum)){
        html=html.replace(
          'class="finding-summary">'+esc(sum),
          'class="finding-summary"><i class="fa-solid fa-circle-info"></i> NumVerify: Skipped (no API key configured). Set NUMVERIFY_API_KEY for carrier lookup, validity, and location data.'
        );
      }else if(raw.valid!==undefined){
        let nv='<div style="margin-top:.6rem;padding:.6rem;background:rgba(6,182,212,.06);border:1px solid rgba(6,182,212,.15);border-radius:4px;font-size:.85rem;line-height:1.8">';
        nv+='<div style="font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:var(--cyan);margin-bottom:.3rem"><i class="fa-solid fa-phone"></i> NumVerify Full Lookup</div>';
        nv+='<div><strong>Valid:</strong> '+(raw.valid?'<span style="color:var(--green)">Yes</span>':'<span style="color:var(--red)">No</span>')+'</div>';
        if(raw.international_format) nv+='<div><strong>International:</strong> '+esc(raw.international_format)+'</div>';
        if(raw.local_format) nv+='<div><strong>Local:</strong> '+esc(raw.local_format)+'</div>';
        if(raw.carrier) nv+='<div><strong>Carrier:</strong> '+esc(raw.carrier)+'</div>';
        if(raw.line_type) nv+='<div><strong>Line Type:</strong> '+esc(raw.line_type)+'</div>';
        if(raw.location) nv+='<div><strong>Location:</strong> '+esc(raw.location)+'</div>';
        if(raw.country_name) nv+='<div><strong>Country:</strong> '+esc(raw.country_name)+(raw.country_code?' ('+esc(raw.country_code)+')':'')+'</div>';
        nv+='</div>';
        html+=nv;
      }
    }

    // IP-Geo enhanced rendering
    if(/ip.?geo/i.test(f.tool_name) && raw.city){
      let ig='<div class="finding-detail-box">';
      ig+='<div class="detail-title"><i class="fa-solid fa-globe"></i> Geolocation &amp; Network Intel</div>';
      if(raw.city)      ig+='<div><strong>Location:</strong> '+esc([raw.city,raw.region,raw.country].filter(Boolean).join(', '))+'</div>';
      if(raw.timezone)  ig+='<div><strong>Timezone:</strong> '+esc(raw.timezone)+'</div>';
      if(raw.isp)       ig+='<div><strong>ISP:</strong> '+esc(raw.isp)+'</div>';
      if(raw.org)       ig+='<div><strong>Org:</strong> '+esc(raw.org)+'</div>';
      if(raw.asn)       ig+='<div><strong>ASN:</strong> '+esc(raw.asn)+'</div>';
      if(raw.asname)    ig+='<div><strong>AS Name:</strong> '+esc(raw.asname)+'</div>';
      if(raw.reverse_dns) ig+='<div><strong>Reverse DNS:</strong> '+esc(raw.reverse_dns)+'</div>';
      const flags=[];
      if(raw.proxy)   flags.push('Proxy/VPN');
      if(raw.hosting) flags.push('Datacenter');
      if(raw.mobile)  flags.push('Mobile');
      if(flags.length) ig+='<div style="margin-top:.3rem">'+flags.map(f=>'<span class="flag-badge">'+esc(f)+'</span>').join('')+'</div>';
      ig+='</div>';
      if(raw.lat&&raw.lon){
        const mUrl='https://www.google.com/maps?q='+encodeURIComponent(raw.lat+','+raw.lon);
        ig+='<div class="finding-actions"><a class="btn btn-amber" href="'+esc(mUrl)+'" target="_blank" rel="noopener"><i class="fa-solid fa-map-pin"></i> View on Map</a></div>';
      }
      html+=ig;
    }

    // EmailRep enhanced rendering
    if(/emailrep/i.test(f.tool_name) && raw.reputation!==undefined){
      let er='<div class="finding-detail-box">';
      er+='<div class="detail-title"><i class="fa-solid fa-shield-halved"></i> Email Reputation Detail</div>';
      const repColor=raw.reputation==='high'?'#22c55e':raw.reputation==='medium'?'#eab308':'#f97316';
      er+='<div><strong>Reputation:</strong> <span style="color:'+repColor+'">'+esc(raw.reputation||'unknown')+'</span></div>';
      if(raw.references!==undefined) er+='<div><strong>Web References:</strong> '+esc(raw.references)+'</div>';
      if(raw.last_seen) er+='<div><strong>Last Seen:</strong> '+esc(raw.last_seen)+'</div>';
      if(raw.domain_reputation) er+='<div><strong>Domain Rep:</strong> '+esc(raw.domain_reputation)+'</div>';
      const alerts=[];
      if(raw.data_breach)         alerts.push('Data Breach');
      if(raw.credentials_leaked)  alerts.push('Credentials Leaked');
      if(raw.malicious_activity)  alerts.push('Malicious Activity');
      if(raw.blacklisted)         alerts.push('Blacklisted');
      if(raw.spam)                alerts.push('Spam');
      if(raw.disposable)          alerts.push('Disposable');
      if(alerts.length) er+='<div style="margin-top:.3rem">'+alerts.map(a=>'<span class="flag-badge">'+esc(a)+'</span>').join('')+'</div>';
      if(raw.profiles&&raw.profiles.length){
        er+='<div style="margin-top:.4rem"><strong>Associated Profiles:</strong><br>';
        er+=raw.profiles.map(p=>'<span class="platforms-list"><span>'+esc(p)+'</span></span>').join('');
        er+='</div>';
      }
      er+='</div>';
      html+=er;
    }

    // DomainRep enhanced rendering
    if(/domainrep/i.test(f.tool_name)){
      const dnsbl=raw.dnsbl||{};
      const urlscan=raw.urlscan||{};
      let dr='<div class="finding-detail-box">';
      dr+='<div class="detail-title"><i class="fa-solid fa-shield-virus"></i> Domain Reputation Detail</div>';
      const listed=dnsbl.listed_on||[];
      dr+='<div><strong>DNSBL Lists:</strong> '+(listed.length?'<span style="color:#f97316">'+esc(listed.length)+' blacklist(s)</span>':'<span style="color:#22c55e">Clean</span>')+'</div>';
      if(listed.length) dr+='<div>'+listed.map(l=>'<span class="flag-badge">'+esc(l)+'</span>').join('')+'</div>';
      if(urlscan.total_historical_scans!==undefined){
        dr+='<div><strong>URLScan History:</strong> '+esc(urlscan.total_historical_scans)+' scan(s) on record</div>';
        if(urlscan.malicious_count) dr+='<div><strong>Malicious Verdicts:</strong> <span style="color:#f97316">'+esc(urlscan.malicious_count)+'</span></div>';
        if(urlscan.recent_scans&&urlscan.recent_scans.length){
          const ms=urlscan.recent_scans.filter(s=>s.malicious);
          if(ms.length){
            dr+='<div style="margin-top:.3rem"><strong>Malicious URLs:</strong><br>';
            ms.slice(0,3).forEach(s=>{ dr+='<div style="font-size:.75rem;color:#f97316;word-break:break-all">'+esc(s.url)+'</div>'; });
            dr+='</div>';
          }
        }
      }
      dr+='</div>';
      html+=dr;
    }

    // NameOSINT enhanced rendering
    if(/nameosint/i.test(f.tool_name)){
      const profiles=raw.probable_profiles||[];
      let no='<div class="finding-detail-box">';
      no+='<div class="detail-title"><i class="fa-solid fa-user-magnifying-glass"></i> Social Presence Probe</div>';
      if(raw.username_variants&&raw.username_variants.length){
        no+='<div><strong>Username Variants Tested:</strong> '+raw.username_variants.slice(0,6).map(v=>'<code style="font-size:.75rem">'+esc(v)+'</code>').join(', ')+'</div>';
      }
      if(profiles.length){
        no+='<div style="margin-top:.4rem"><strong>Probable Profiles ('+profiles.length+'):</strong></div>';
        no+='<div style="margin-top:.3rem">';
        profiles.forEach(p=>{
          no+='<a class="profile-link" href="'+esc(p.url)+'" target="_blank" rel="noopener"><i class="fa-solid fa-arrow-up-right-from-square"></i> '+esc(p.platform)+' / '+esc(p.username)+'</a>';
        });
        no+='</div>';
      }else{
        no+='<div style="color:var(--text-dim);font-size:.8rem;margin-top:.3rem">No obvious profiles found. Manual verification recommended.</div>';
      }
      no+='</div>';
      html+=no;
    }

    // HaveIBeenPwned enhanced rendering (already has breach_names block above, add count)
    if(/haveibeenpwned/i.test(f.tool_name)&&raw.breach_count!==undefined&&raw.breach_count>0){
      let hb='<div class="finding-detail-box">';
      hb+='<div class="detail-title"><i class="fa-solid fa-database"></i> Breach Summary</div>';
      hb+='<div><strong>Breaches:</strong> <span style="color:#f97316">'+esc(raw.breach_count)+'</span></div>';
      if(raw.total_records_exposed) hb+='<div><strong>Records Exposed:</strong> '+esc(raw.total_records_exposed.toLocaleString())+'</div>';
      if(raw.data_classes&&raw.data_classes.length){
        hb+='<div><strong>Data Types:</strong> '+raw.data_classes.slice(0,8).map(d=>'<span class="flag-badge">'+esc(d)+'</span>').join('')+'</div>';
      }
      hb+='</div>';
      html+=hb;
    }

    // Cross-references section
    const links=f.links||[];
    if(links.length>0){
      // Deduplicate by entity_id
      const seen=new Set();
      const uniq=links.filter(l=>{if(seen.has(l.entity_id))return false;seen.add(l.entity_id);return true;});
      let xr='<div class="cross-ref-section">';
      xr+='<div class="cross-ref-header"><i class="fa-solid fa-link"></i> Cross-References <span class="cross-ref-badge">'+uniq.length+' link'+(uniq.length!==1?'s':'')+'</span></div>';
      uniq.forEach(link=>{
        const pid=esc(link.project_id||'');
        const pname=esc(link.project_name||'Unknown Project');
        const etype=esc(link.entity_type||'');
        const eval_=esc(link.entity_value||'');
        const reason=esc(link.match_reason||'value match');
        xr+='<div class="cross-ref-item">';
        xr+='<div><span style="color:var(--cyan);font-family:monospace">'+etype+'</span> <strong>'+eval_+'</strong><div class="xref-meta">in &ldquo;'+pname+'&rdquo; &mdash; '+reason+'</div></div>';
        xr+='<button class="btn-xref" onclick="viewCrossRef(\''+pid+'\',\''+pname.replace(/'/g,"\\'")+'\')" title="Open linked investigation"><i class="fa-solid fa-arrow-up-right-from-square"></i> View</button>';
        xr+='</div>';
      });
      xr+='</div>';
      html+=xr;
    }

    card.innerHTML=html;
    grid.appendChild(card);
  });
}

/* ─── AI Analysis (with teaser for free users) ─── */
async function runAnalysis(){
  if(!isDisclaimerAcknowledged()){log('ERROR: Acknowledge the ethical use disclaimer first','error');return}
  if(!projectId){log('ERROR: No active project','error');return}

  // Freemium gate for AI analysis too
  if(!isPremium() && !canRun()){
    log('Daily free limit reached. Upgrade for unlimited AI analysis.','warn');
    showPaywall();
    return;
  }

  const btn=document.getElementById('btnAnalyze');
  btn.disabled=true;
  document.getElementById('analyzeStatus').classList.add('active');
  log('Running AI analysis...','warn');
  recordAnalysis();

  // AI runs consume daily quota for free users (not admin)
  if(!isAdmin() && !isPremium()) incrementRunCount();

  try{
    const data=await api('POST','/projects/'+projectId+'/analyze',null,true);
    log('AI analysis complete: '+data.patterns_created+' insight(s) found','info');
    document.getElementById('analyzeStatus').classList.remove('active');
    await loadPatterns();
    loadPlatformStats();
    btn.disabled=false;

    // Update history with analysis summary
    const invName2=document.getElementById('currentInvName').textContent||'Unknown';
    const targets2=entities.map(e=>({type:e.entity_type,value:e.value}));
    addToHistory(projectId, invName2, targets2, data.patterns_created+' patterns detected via AI analysis');

    // If free user (and no per-report unlock), show teaser overlay with limited info
    if(!isAdmin() && !isPremium() && !isReportUnlocked(projectId)){
      const patterns=await api('GET','/projects/'+projectId+'/patterns');
      let basicSummary = '';
      const riskP = patterns.find(p => p.pattern_type === 'risk_score');
      if(riskP) basicSummary += 'Risk Level: ' + riskP.description.toUpperCase() + '. ';
      if(data.patterns_created === 0){
        basicSummary += 'AI analysis ran but produced no structured patterns. This can happen when findings are minimal or the target returned limited public data. Run OSINT first, then re-run analysis.';
      } else {
        const summaryPattern = patterns.find(p => p.pattern_type === 'summary');
        if(summaryPattern){
          const desc = summaryPattern.description || '';
          basicSummary += desc.length > 280 ? desc.slice(0, 280) + '...' : desc;
        } else {
          basicSummary += data.patterns_created + ' pattern(s) detected by AI. Full details available in the premium report.';
        }
      }
      showAiTeaser(basicSummary || 'Analysis complete. Upgrade to view full patterns and risk breakdown.');
    }
  }catch(e){
    log('ANALYSIS ERROR: '+e.message,'error');
    recordError();
    document.getElementById('analyzeStatus').classList.remove('active');
    btn.disabled=false;
  }
}

async function loadPatterns(){
  if(!projectId) return;
  try{
    const patterns=await api('GET','/projects/'+projectId+'/patterns');
    document.getElementById('statPatterns').textContent=patterns.length;
    document.getElementById('patternsCount').textContent=patterns.length;
    if(patterns.length>0){
      const pp=document.getElementById('panelPatterns');
      pp.classList.remove('hidden','collapsed');
      // Premium/admin see full patterns; per-report purchasers see full for that project; free users see limited
      if(isPremium() || isReportUnlocked(projectId)){
        renderPatterns(patterns);
        renderDownloadButton();
      } else {
        renderPatternsLimited(patterns);
      }
    }
  }catch(e){
    log('PATTERN LOAD ERROR: '+e.message,'error');
  }
}

function renderPatterns(patterns){
  const container=document.getElementById('patternsContainer');
  container.innerHTML='';

  // Render risk score badge first if present
  const riskPattern=patterns.find(p=>p.pattern_type==='risk_score');
  if(riskPattern){
    const score=riskPattern.description||'unknown';
    const colorMap={low:'var(--green)',medium:'var(--amber)',high:'var(--red)',critical:'#ff0066'};
    const bgMap={low:'rgba(0,255,0,.08)',medium:'rgba(245,158,11,.08)',high:'rgba(255,0,0,.08)',critical:'rgba(255,0,102,.12)'};
    const badge=document.createElement('div');
    badge.style.cssText='text-align:center;padding:1rem;margin-bottom:1rem;border:2px solid '+(colorMap[score]||'var(--text-dim)')+';border-radius:4px;background:'+(bgMap[score]||'transparent');
    badge.innerHTML='<div style="font-size:.7rem;letter-spacing:.2em;text-transform:uppercase;color:var(--text-dim);margin-bottom:.3rem"><i class="fa-solid fa-shield-halved"></i> AI RISK ASSESSMENT</div>'
      +'<div style="font-size:1.75rem;font-weight:bold;color:'+(colorMap[score]||'var(--text)')+';letter-spacing:.15em;text-transform:uppercase;text-shadow:0 0 20px '+(colorMap[score]||'transparent')+'">'+esc(score)+'</div>'
      +'<div style="font-size:.7rem;color:var(--text-dim);margin-top:.3rem">Model: '+esc(riskPattern.llm_model||'--')+' &middot; Confidence: '+Math.round((riskPattern.confidence||0)*100)+'%</div>';
    container.appendChild(badge);
  }

  const typeOrder=['summary','relationship','anomaly','lead','recommendation'];
  const displayPatterns=patterns.filter(p=>p.pattern_type!=='risk_score');
  displayPatterns.sort((a,b)=>{
    const ai=typeOrder.indexOf(a.pattern_type),bi=typeOrder.indexOf(b.pattern_type);
    return (ai===-1?99:ai)-(bi===-1?99:bi);
  });
  displayPatterns.forEach(p=>{
    const card=document.createElement('div');
    card.className='pattern-card type-'+(p.pattern_type||'summary');
    const iconMap={summary:'fa-file-lines',relationship:'fa-link',anomaly:'fa-triangle-exclamation',lead:'fa-lightbulb',recommendation:'fa-clipboard-check'};
    const labelMap={summary:'Summary',relationship:'Connections',anomaly:'Flags',lead:'Next Steps',recommendation:'Advice'};
    const icon=iconMap[p.pattern_type]||'fa-circle-info';
    const label=labelMap[p.pattern_type]||p.pattern_type||'Insight';
    card.innerHTML='<div class="pattern-type"><i class="fa-solid '+icon+'"></i> '+esc(label)+'</div>'
      +'<div class="pattern-desc">'+esc(p.description||'No description')+'</div>'
      +'<div class="pattern-conf">Confidence: '+(p.confidence!==undefined?Math.round(p.confidence*100)+'%':'N/A')
      +(p.llm_model?' &middot; Model: '+esc(p.llm_model):'')+'</div>';
    container.appendChild(card);
  });
}

function renderPatternsLimited(patterns){
  const container=document.getElementById('patternsContainer');
  container.innerHTML='';

  // Show risk score badge for free users (visible but teased)
  const riskPattern=patterns.find(p=>p.pattern_type==='risk_score');
  if(riskPattern){
    const score=riskPattern.description||'unknown';
    const colorMap={low:'var(--green)',medium:'var(--amber)',high:'var(--red)',critical:'#ff0066'};
    const bgMap={low:'rgba(0,255,0,.08)',medium:'rgba(245,158,11,.08)',high:'rgba(255,0,0,.08)',critical:'rgba(255,0,102,.12)'};
    const badge=document.createElement('div');
    badge.style.cssText='text-align:center;padding:1rem;margin-bottom:1rem;border:2px solid '+(colorMap[score]||'var(--text-dim)')+';border-radius:4px;background:'+(bgMap[score]||'transparent');
    badge.innerHTML='<div style="font-size:.7rem;letter-spacing:.2em;text-transform:uppercase;color:var(--text-dim);margin-bottom:.3rem"><i class="fa-solid fa-shield-halved"></i> AI RISK ASSESSMENT</div>'
      +'<div style="font-size:1.75rem;font-weight:bold;color:'+(colorMap[score]||'var(--text)')+';letter-spacing:.15em;text-transform:uppercase;text-shadow:0 0 20px '+(colorMap[score]||'transparent')+'">'+esc(score)+'</div>'
      +'<div style="font-size:.65rem;color:var(--text-muted);margin-top:.3rem"><i class="fa-solid fa-lock"></i> Full risk breakdown available in Premium</div>';
    container.appendChild(badge);
  }

  // Show only summary types for free users, blur the rest
  const typeOrder=['summary','relationship','anomaly','lead','recommendation'];
  const displayPatterns=patterns.filter(p=>p.pattern_type!=='risk_score');
  displayPatterns.sort((a,b)=>{
    const ai=typeOrder.indexOf(a.pattern_type),bi=typeOrder.indexOf(b.pattern_type);
    return (ai===-1?99:ai)-(bi===-1?99:bi);
  });
  let shown = 0;
  displayPatterns.forEach(p=>{
    const card=document.createElement('div');
    card.className='pattern-card type-'+(p.pattern_type||'summary');
    const iconMap={summary:'fa-file-lines',relationship:'fa-link',anomaly:'fa-triangle-exclamation',lead:'fa-lightbulb',recommendation:'fa-clipboard-check'};
    const labelMap={summary:'Summary',relationship:'Connections',anomaly:'Flags',lead:'Next Steps',recommendation:'Advice'};
    const icon=iconMap[p.pattern_type]||'fa-circle-info';
    const label=labelMap[p.pattern_type]||p.pattern_type||'Insight';

    if(p.pattern_type === 'summary' && shown < 1){
      // Show first summary in full
      card.innerHTML='<div class="pattern-type"><i class="fa-solid '+icon+'"></i> '+esc(label)+'</div>'
        +'<div class="pattern-desc">'+esc(p.description||'No description')+'</div>'
        +'<div class="pattern-conf">Confidence: '+(p.confidence!==undefined?Math.round(p.confidence*100)+'%':'N/A')+'</div>';
      shown++;
    } else {
      // Blurred/locked for free users
      card.style.filter='blur(4px)';
      card.style.userSelect='none';
      card.style.position='relative';
      card.innerHTML='<div class="pattern-type"><i class="fa-solid '+icon+'"></i> '+esc(label)+'</div>'
        +'<div class="pattern-desc">'+esc(p.description||'No description')+'</div>'
        +'<div class="pattern-conf">Confidence: '+(p.confidence!==undefined?Math.round(p.confidence*100)+'%':'N/A')+'</div>';
    }
    container.appendChild(card);
  });

  // Add buy-report + upgrade prompt at bottom
  const upsell = document.createElement('div');
  upsell.style.cssText = 'text-align:center;padding:1.25rem;border:1px dashed var(--cyan);border-radius:4px;margin-top:1rem;background:rgba(6,182,212,.03)';
  upsell.innerHTML = '<div style="color:var(--cyan);font-size:1rem;margin-bottom:.5rem"><i class="fa-solid fa-file-shield"></i> Full Report Available</div>'
    + '<div style="color:var(--text-dim);font-size:.85rem;margin-bottom:1rem;line-height:1.6">Deep pattern detection, risk scoring, entity linking, anomaly alerts, and threat recommendations with downloadable report.</div>'
    + '<div style="display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;align-items:center">'
    + '<button class="btn btn-buy-report btn-lg" onclick="showReportPay()"><i class="fa-solid fa-file-shield"></i> Get Full Report &mdash; $4.99</button>'
    + '<span style="color:var(--text-muted);font-size:.75rem">or</span>'
    + '<button class="btn btn-amber" onclick="showPaywall()"><i class="fa-solid fa-crown"></i> Subscribe $9.99/mo</button>'
    + '</div>';
  container.appendChild(upsell);
}

function renderDownloadButton(){
  const container=document.getElementById('patternsContainer');
  // Add download report button for premium users
  if(!document.getElementById('btnDownloadReport')){
    const wrap = document.createElement('div');
    wrap.style.cssText = 'text-align:center;margin-top:1rem;';
    wrap.innerHTML = '<button class="btn btn-green btn-lg" id="btnDownloadReport" onclick="downloadReport()">'
      + '<i class="fa-solid fa-download"></i> Download Report</button>';
    container.appendChild(wrap);
  }
}

async function downloadReport(){
  if(!projectId) return;
  try{
    const report = await api('GET','/projects/'+projectId+'/report');
    const blob = new Blob([JSON.stringify(report, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'valkyrie-report-'+projectId.slice(0,8)+'.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    log('Full report downloaded','info');
  }catch(e){
    log('DOWNLOAD ERROR: '+e.message,'error');
  }
}

/* ─── Utilities ─── */
function esc(s){
  if(!s) return '';
  const d=document.createElement('div');
  d.textContent=String(s);
  return d.innerHTML;
}

/* ─── Load Existing Investigations on Page Load ─── */
async function loadInvestigations(){
  try{
    const projects=await api('GET','/projects');
    if(!projects||projects.length===0){
      document.getElementById('panelInvestigations').classList.add('hidden');
      return;
    }
    document.getElementById('panelInvestigations').classList.remove('hidden');

    const details=[];
    for(const p of projects){
      // Skip archived projects
      if(p.status==='archived') continue;
      try{
        const report=await api('GET','/projects/'+p.id+'/report');
        const ec=report.summary?report.summary.total_entities:0;
        const fc=report.summary?report.summary.total_findings:0;
        const pc=report.summary?report.summary.total_patterns:0;
        const lc=report.summary?report.summary.total_links||0:0;
        details.push({id:p.id,name:p.name,status:p.status,entities:ec,findings:fc,patterns:pc,links:lc});
      }catch(e){
        details.push({id:p.id,name:p.name,status:p.status,entities:0,findings:0,patterns:0,links:0});
      }
    }

    if(details.length===0){
      document.getElementById('panelInvestigations').classList.add('hidden');
      return;
    }

    const body=document.getElementById('investigationsBody');
    let html='<table class="inv-table"><thead><tr><th>Project</th><th>Status</th><th>Entities</th><th>Findings</th><th>Links</th><th></th></tr></thead><tbody>';
    details.forEach(d=>{
      const isDemo=/demo|dude/i.test(d.name);
      const sel=d.id===projectId?' selected':'';
      const demo=isDemo?' demo-highlight':'';
      html+='<tr class="'+sel+demo+'" onclick="selectProject(\''+d.id+'\',\''+esc(d.name)+'\')">';
      html+='<td>'+esc(d.name)+'</td><td>'+esc(d.status)+'</td><td>'+d.entities+'</td><td>'+d.findings+'</td>';
      const linkBadge=d.links>0?'<span class="xref-count-badge"><i class="fa-solid fa-link"></i> '+d.links+'</span>':'<span style="color:var(--text-dim);font-size:.75rem">—</span>';
      html+='<td>'+linkBadge+'</td>';
      html+='<td><button class="btn-delete-sm" onclick="deleteProject(\''+d.id+'\',\''+esc(d.name).replace(/'/g,"\\'")+'\',event)" title="Delete investigation"><i class="fa-solid fa-trash"></i></button></td>';
      html+='</tr>';
    });
    html+='</tbody></table>';
    body.innerHTML=html;

    // Stats row only shows current project — don't overwrite with aggregates
    document.getElementById('statsRow').classList.remove('hidden');

    // Update tab counts
    document.getElementById('invActiveCount').textContent=details.length;
    document.getElementById('invHistoryCount').textContent=getHistory().length;

    log(details.length+' investigation(s) loaded','info');
    document.getElementById('dossierProjects').textContent=projects.length;

    if(!projectId||!details.find(d=>d.id===projectId)){
      const autoSelect=details.find(d=>/demo|dude/i.test(d.name))||details[0];
      if(autoSelect){
        selectProject(autoSelect.id,autoSelect.name);
        log('AUTO-SELECT: '+autoSelect.name,'system');
      }
    }else if(projectId){
      loadFindings();
      loadPatterns();
    }
  }catch(e){
    log('LOAD ERROR: '+e.message,'error');
  }
}

function selectProject(id,name){
  // ─── PROJECT ISOLATION: clear everything before loading ───
  entities=[];
  document.getElementById('entityList').innerHTML='';
  document.getElementById('clearTargetsBar').classList.add('hidden');
  document.getElementById('findingsGrid').innerHTML='';
  document.getElementById('panelFindings').classList.add('hidden','collapsed');
  document.getElementById('findingsCount').textContent='0';
  document.getElementById('patternsContainer').innerHTML='';
  document.getElementById('panelPatterns').classList.add('hidden','collapsed');
  document.getElementById('patternsCount').textContent='0';
  document.getElementById('statEntities').textContent='0';
  document.getElementById('statFindings').textContent='0';
  document.getElementById('statPatterns').textContent='0';
  document.getElementById('statSeverity').textContent='--';
  setThreatLevel('minimal');

  projectId=id;
  sessionStorage.setItem('projectId',id);
  document.getElementById('btnAddEntity').disabled=false;
  document.getElementById('btnRun').disabled=false;
  document.getElementById('btnRun').removeAttribute('title');
  document.getElementById('btnAnalyze').disabled=false;
  document.getElementById('btnAnalyze').removeAttribute('title');
  document.getElementById('projectIdDisplay').textContent='Project ID: '+id;
  document.getElementById('projectIdDisplay').classList.remove('hidden');
  document.getElementById('btnCreateProject').innerHTML='<i class="fa-solid fa-check"></i> Project Active';
  document.getElementById('btnCreateProject').disabled=true;
  log('SELECTED: '+name+' ['+id.slice(0,8)+']','system');

  // Show current investigation context label
  document.getElementById('currentInvLabel').classList.remove('hidden');
  document.getElementById('currentInvName').textContent=name;
  document.getElementById('currentInvId').textContent='['+id.slice(0,8)+']';

  document.querySelectorAll('.inv-table tr').forEach(r=>r.classList.remove('selected'));
  if(event && event.currentTarget) event.currentTarget.classList.add('selected');

  // Update step indicator — project selected means at least step 2
  setStep(2);

  api('GET','/projects/'+id+'/entities').then(ents=>{
    entities=ents||[];
    renderEntityList();
    if(entities.length>0) setStep(3);
  }).catch(()=>{});

  loadFindings();
  loadPatterns();
}

/* ─── Platform Aggregate Stats (from backend) ─── */
async function loadPlatformStats(){
  try{
    const res=await fetch('/api/v1/stats/aggregate');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const s=await res.json();
    const el=document.getElementById('platformStatsBody');
    if(!s.total_runs && !s.total_analyses){
      el.textContent='No usage data yet. Run an OSINT operation to begin.';
      return;
    }
    let html='<div style="display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap">';
    html+='<div><span style="color:var(--green);font-size:1.25rem;font-weight:bold">'+s.total_runs+'</span><br><span style="font-size:.7rem;letter-spacing:.1em">TOTAL RUNS</span></div>';
    html+='<div><span style="color:var(--cyan);font-size:1.25rem;font-weight:bold">'+s.total_analyses+'</span><br><span style="font-size:.7rem;letter-spacing:.1em">AI ANALYSES</span></div>';
    html+='<div><span style="color:'+(s.error_rate_pct>10?'var(--red)':'var(--amber)')+';font-size:1.25rem;font-weight:bold">'+s.error_rate_pct+'%</span><br><span style="font-size:.7rem;letter-spacing:.1em">ERROR RATE</span></div>';
    html+='</div>';
    // Target type breakdown
    if(s.target_type_pct && Object.keys(s.target_type_pct).length>0){
      html+='<div style="margin-top:.75rem;font-size:.75rem;color:var(--text-dim)">';
      html+='<span style="letter-spacing:.1em">TARGET MIX:</span> ';
      const entries=Object.entries(s.target_type_pct).sort((a,b)=>b[1]-a[1]);
      entries.forEach(([t,pct],i)=>{
        html+='<span style="color:var(--text);margin:0 .3rem">'+t.toUpperCase()+' '+pct+'%</span>';
        if(i<entries.length-1) html+='<span style="color:var(--border-light)">&middot;</span>';
      });
      html+='</div>';
    }
    el.innerHTML=html;
  }catch(e){
    document.getElementById('platformStatsBody').textContent='Stats unavailable';
  }
}
// Load stats on page load (no auth needed)
loadPlatformStats();

/* ─── AI Premium Gate Visibility ─── */
function updateAiPremiumUI(){
  const gate=document.getElementById('aiPremiumGate');
  const preview=document.getElementById('aiExamplePreview');
  const badge=document.querySelector('#btnAnalyze span[style]');
  if(isPremium()){
    if(gate) gate.classList.add('hidden');
    if(preview) preview.classList.add('hidden');
    if(badge) badge.style.display='none';
  }else{
    if(gate) gate.classList.remove('hidden');
    if(preview) preview.classList.remove('hidden');
    if(badge) badge.style.display='';
  }
}

/* ─── Onboarding Banner ─── */
function showOnboardingIfNeeded(){
  if(sessionStorage.getItem('vk_onboarding_dismissed')==='1') return;
  document.getElementById('onboardingBanner').classList.remove('hidden');
}
function dismissOnboarding(){
  sessionStorage.setItem('vk_onboarding_dismissed','1');
  document.getElementById('onboardingBanner').classList.add('hidden');
}

/* ─── Step Indicator ─── */
let currentStep=1;
function setStep(step){
  currentStep=step;
  for(let i=1;i<=4;i++){
    const el=document.getElementById('step'+i);
    el.classList.remove('active','complete');
    if(i<step) el.classList.add('complete');
    else if(i===step) el.classList.add('active');
  }
  for(let i=1;i<=3;i++){
    const conn=document.getElementById('conn'+i+'-'+(i+1));
    conn.classList.toggle('done',i<step);
  }
  // Update step-num content for completed steps
  for(let i=1;i<=4;i++){
    const numEl=document.getElementById('step'+i).querySelector('.step-num');
    if(i<step) numEl.innerHTML='<i class="fa-solid fa-check" style="font-size:.65rem"></i>';
    else numEl.textContent=i;
  }
}

/* ─── Panel Toggle (collapsible) ─── */
function togglePanel(panelId){
  document.getElementById(panelId).classList.toggle('collapsed');
}

/* ─── New Investigation (full UI reset) ─── */
function newInvestigation(){
  projectId=null;
  entities=[];
  sessionStorage.removeItem('projectId');

  // Clear entity list
  document.getElementById('entityList').innerHTML='';
  document.getElementById('clearTargetsBar').classList.add('hidden');

  // Clear findings
  document.getElementById('findingsGrid').innerHTML='';
  document.getElementById('panelFindings').classList.add('hidden','collapsed');
  document.getElementById('findingsCount').textContent='0';

  // Clear patterns
  document.getElementById('patternsContainer').innerHTML='';
  document.getElementById('panelPatterns').classList.add('hidden','collapsed');
  document.getElementById('patternsCount').textContent='0';

  // Reset stats
  document.getElementById('statEntities').textContent='0';
  document.getElementById('statFindings').textContent='0';
  document.getElementById('statPatterns').textContent='0';
  document.getElementById('statSeverity').textContent='--';

  // Reset project creation form
  document.getElementById('projName').value='';
  document.getElementById('projDesc').value='';
  document.getElementById('projectIdDisplay').classList.add('hidden');
  document.getElementById('projectIdDisplay').textContent='';
  const btn=document.getElementById('btnCreateProject');
  btn.disabled=false;
  btn.innerHTML='<i class="fa-solid fa-rocket"></i> Create Investigation';

  // Reset buttons
  document.getElementById('btnAddEntity').disabled=true;
  document.getElementById('btnRun').disabled=true;
  document.getElementById('btnRun').setAttribute('title','Select an investigation first');
  document.getElementById('btnAnalyze').disabled=true;
  document.getElementById('btnAnalyze').setAttribute('title','Select an investigation first');

  // Deselect in table
  document.querySelectorAll('.inv-table tr').forEach(r=>r.classList.remove('selected'));

  // Hide current investigation label
  document.getElementById('currentInvLabel').classList.add('hidden');

  // Reset step indicator
  setStep(1);

  // Reset threat meter
  setThreatLevel('minimal');

  log('NEW INVESTIGATION: UI state cleared. Ready for new project.','system');
}

/* ─── Delete Project ─── */
async function deleteProject(id, name, evt){
  evt.stopPropagation();
  if(!confirm('Delete investigation "'+name+'"? This cannot be undone.')) return;
  try{
    await api('DELETE','/projects/'+id);
    log('DELETED: Investigation "'+name+'" removed','warn');
    removeFromHistory(id);
    // If we deleted the active project, reset UI
    if(projectId===id) newInvestigation();
    loadInvestigations();
  }catch(e){
    log('DELETE ERROR: '+e.message,'error');
  }
}

/* ─── Investigation History ─── */
let currentInvTab='active';

function getHistoryStorage(){
  // Premium users: localStorage (persistent). Free: sessionStorage (session only).
  return isPremium() ? localStorage : sessionStorage;
}
function getHistory(){
  try{
    return JSON.parse(getHistoryStorage().getItem('vk_inv_history') || '[]');
  }catch(e){return []}
}
function saveHistory(history){
  getHistoryStorage().setItem('vk_inv_history', JSON.stringify(history));
}
function migrateHistoryOnUpgrade(){
  // If user just became premium, move session history to localStorage
  const sess = sessionStorage.getItem('vk_inv_history');
  if(sess && isPremium()){
    const existing = JSON.parse(localStorage.getItem('vk_inv_history') || '[]');
    const sessData = JSON.parse(sess);
    const merged = [...existing];
    sessData.forEach(s=>{
      if(!merged.find(m=>m.id===s.id)) merged.push(s);
    });
    localStorage.setItem('vk_inv_history', JSON.stringify(merged));
    sessionStorage.removeItem('vk_inv_history');
  }
}

function viewCrossRef(linkedProjectId, linkedProjectName){
  if(!linkedProjectId){log('CROSS-REF: No project ID for linked entity','error');return;}
  log('CROSS-REF: Navigating to linked investigation "'+linkedProjectName+'"...','warn');
  selectProject(linkedProjectId, linkedProjectName);
  // Scroll to investigations panel
  const invPanel=document.getElementById('panelInvestigations');
  if(invPanel) invPanel.scrollIntoView({behavior:'smooth',block:'start'});
}

function addToHistory(pid, name, targets, summary){
  const history = getHistory();
  // Update existing or add new
  const idx = history.findIndex(h=>h.id===pid);
  const entry = {
    id: pid,
    name: name,
    date: new Date().toISOString(),
    targets: targets || [],
    summary: summary || ''
  };
  if(idx>=0) history[idx]=entry;
  else history.unshift(entry);
  // Cap at 50 entries
  if(history.length>50) history.length=50;
  saveHistory(history);
}

function removeFromHistory(pid){
  const history = getHistory().filter(h=>h.id!==pid);
  saveHistory(history);
  renderHistoryTab();
}

function clearAllHistory(){
  if(!confirm('Clear all investigation history? This cannot be undone.')) return;
  saveHistory([]);
  renderHistoryTab();
  log('HISTORY: All investigation history cleared','warn');
}

function showInvTab(tab){
  currentInvTab=tab;
  document.getElementById('invTabActive').classList.toggle('active',tab==='active');
  document.getElementById('invTabHistory').classList.toggle('active',tab==='history');
  document.getElementById('investigationsBody').classList.toggle('hidden',tab!=='active');
  document.getElementById('investigationsHistoryBody').classList.toggle('hidden',tab!=='history');
  document.getElementById('invClearBar').classList.toggle('hidden',tab!=='history');
  if(tab==='history') renderHistoryTab();
}

function renderHistoryTab(){
  const history = getHistory();
  const body = document.getElementById('investigationsHistoryBody');
  document.getElementById('invHistoryCount').textContent=history.length;

  // Update persistence note
  const noteText = document.getElementById('invPersistText');
  if(isPremium()){
    noteText.innerHTML='<i class="fa-solid fa-crown" style="color:var(--green);margin-right:.2rem"></i> History saved permanently to your account';
  } else {
    noteText.textContent='History saved this session only — upgrade for permanent history';
  }

  if(history.length===0){
    body.innerHTML='<div class="inv-empty"><i class="fa-solid fa-clock-rotate-left" style="margin-right:.4rem"></i> No investigation history yet. Run an OSINT operation to begin.</div>';
    return;
  }

  let html='<table class="inv-table"><thead><tr><th>Date</th><th>Investigation</th><th>Targets</th><th>Summary</th><th></th></tr></thead><tbody>';
  history.forEach(h=>{
    const d=new Date(h.date);
    const dateStr=d.toLocaleDateString()+' '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const targetsStr=(h.targets||[]).map(t=>t.type+':'+t.value).join(', ');
    const summaryStr=esc(h.summary||'--').slice(0,80);
    html+='<tr>';
    html+='<td class="col-date">'+esc(dateStr)+'</td>';
    html+='<td>'+esc(h.name)+'</td>';
    html+='<td class="col-targets" title="'+esc(targetsStr)+'">'+esc(targetsStr.length>30?targetsStr.slice(0,30)+'...':targetsStr||'--')+'</td>';
    html+='<td class="col-summary" title="'+esc(h.summary||'')+'">'+summaryStr+'</td>';
    html+='<td><div class="inv-actions">';
    html+='<button class="btn-view-sm" onclick="viewHistoryEntry(\''+h.id+'\',\''+esc(h.name).replace(/'/g,"\\'")+'\')"><i class="fa-solid fa-eye"></i> View</button>';
    html+='<button class="btn-delete-sm" onclick="removeFromHistory(\''+h.id+'\')"><i class="fa-solid fa-trash"></i></button>';
    html+='</div></td>';
    html+='</tr>';
  });
  html+='</tbody></table>';
  body.innerHTML=html;
}

function viewHistoryEntry(pid, name){
  // Switch to active tab and select the project
  showInvTab('active');
  selectProject(pid, name);
}

/* ─── Init ─── */
log('VALKYRIE OSINT Intelligence Platform v2.0','system');
log('System initialized. Checking authentication...','info');
updateFreemiumUI();

const savedProjectId=sessionStorage.getItem('projectId');
if(savedProjectId) projectId=savedProjectId;

(async function init(){
  if(authToken){
    await onAuthSuccess();
  }else{
    document.getElementById('authOverlay').classList.remove('hidden');
    log('Please log in to continue','warn');
  }
})();
</script>
</body>
</html>
